@page "/farmacie/dispozitive-medicale"
@using System.Text
@using System.Text.Json
@using global::Shared.DTOs
@using Client.Services
@using Client.Shared.Dialogs
@using MudBlazor
@inject IDispozitivMedicalClient DispozitivMedicalClient
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IJSRuntime JS

<MudText Typo="Typo.h4" Class="mb-4">Farmacie - Dispozitive Medicale</MudText>

<MudPaper Elevation="3" Class="pa-4">
    <MudToolBar Dense="true" DisableGutters="true" Class="mb-2">
        <MudText Typo="Typo.h6">Lista dispozitivelor medicale (@_totalItems)</MudText>
        <MudSpacer />
        <MudButton Variant="Variant.Filled" Color="Color.Success" StartIcon="@Icons.Material.Filled.Add" OnClick="AddAsync" Disabled="@_loading">Adauga</MudButton>
    </MudToolBar>

    <!-- GROUPING AREA -->
    @if (_hasGrouping)
    {
        <MudPaper Elevation="1" Class="pa-2 mb-2" Style="min-height: 48px; border: 2px dashed #ccc;">
            <MudText Typo="Typo.body2" Class="text-center mud-text-secondary">
                @if (_groupedColumns.Any())
                {
                    <div class="d-flex flex-wrap gap-2 align-center justify-center">
                        <MudText Typo="Typo.caption">Grupat dup?:</MudText>
                        @foreach (var column in _groupedColumns)
                        {
                            <MudChip T="string"
                                     Size="Size.Small" 
                                     Color="Color.Primary" 
                                     OnClose="@(() => RemoveGrouping(column))" 
                                     CloseIcon="@Icons.Material.Filled.Close">
                                @column
                            </MudChip>
                        }
                        <MudButton Size="Size.Small" 
                                   Variant="Variant.Text" 
                                   StartIcon="@Icons.Material.Filled.Clear" 
                                   OnClick="ClearAllGrouping">
                            ?terge toate
                        </MudButton>
                    </div>
                }
                else
                {
                    <span>Trage?i o coloan? aici pentru a grupa datele</span>
                }
            </MudText>
        </MudPaper>
    }

    <!-- SERVER-SIDE GRID WITH PAGINATION AND NATIVE GROUPING -->
    <MudDataGrid @ref="_serverGrid"
                 @key="@($"server-{_gridKey}")"
                 T="DispozitivMedicalDTO"
                 ServerData="LoadServerData"
                 Hover="true"
                 Bordered="true"
                 Dense="true"
                 Striped="true"
                 Filterable="false"
                 SortMode="SortMode.Multiple"
                 Hideable="true"
                 Loading="@_loading"
                 LoadingProgressColor="Color.Primary"
                 CanExpand="true"
                 ExpandMode="DataGridExpandMode.Single"
                 Groupable="true"
                 GroupExpanded="true"
                 DragDropColumnReordering="true"
                 ShowColumnOptions="true"
                 ColumnResizeMode="ResizeMode.Column">

        <ToolBarContent>
            <MudTextField T="string"
                          Value="@_search"
                          ValueChanged="OnSearchChanged"
                          Label="Cauta"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          Variant="Variant.Outlined"
                          Dense="true"
                          Margin="Margin.Dense"
                          Immediate="true"
                          DebounceInterval="300"
                          Class="mx-2"
                          Style="width: 420px;" />

            <MudSelect T="string"
                       Value="@_categorieFilter"
                       ValueChanged="OnCategorieChanged"
                       Label="Categorie"
                       Variant="Variant.Outlined"
                       Dense="true"
                       Margin="Margin.Dense"
                       Class="mx-2"
                       Style="width: 180px;">
                <MudSelectItem Value="@("toate")">Toate</MudSelectItem>
                <MudSelectItem Value="@("Monitoring")">Monitoring</MudSelectItem>
                <MudSelectItem Value="@("Diagnostic")">Diagnostic</MudSelectItem>
                <MudSelectItem Value="@("Chirurgical")">Chirurgical</MudSelectItem>
                <MudSelectItem Value="@("Terapeutic")">Terapeutic</MudSelectItem>
                <MudSelectItem Value="@("Implant")">Implant</MudSelectItem>
            </MudSelect>

            <MudSelect T="string"
                       Value="@_clasaRiscFilter"
                       ValueChanged="OnClasaRiscChanged"
                       Label="Clasa Risc"
                       Variant="Variant.Outlined"
                       Dense="true"
                       Margin="Margin.Dense"
                       Class="mx-2"
                       Style="width: 120px;">
                <MudSelectItem Value="@("toate")">Toate</MudSelectItem>
                <MudSelectItem Value="@("I")">Clasa I</MudSelectItem>
                <MudSelectItem Value="@("IIa")">Clasa IIa</MudSelectItem>
                <MudSelectItem Value="@("IIb")">Clasa IIb</MudSelectItem>
                <MudSelectItem Value="@("III")">Clasa III</MudSelectItem>
            </MudSelect>

            <MudButton Variant="Variant.Text" StartIcon="@Icons.Material.Filled.ClearAll" OnClick="ClearFiltersAndReload" Class="mx-2">Curata</MudButton>

            <MudMenu Label="Coloane" StartIcon="@Icons.Material.Filled.ViewColumn" Class="mx-2" Dense="true">
                <MudMenuItem OnClick="@(() => ToggleColumn(nameof(showDenumire)))">
                    <MudIcon Icon="@(showDenumire ? Icons.Material.Filled.CheckBox : Icons.Material.Outlined.CheckBoxOutlineBlank)" Class="mr-2" /> Denumire
                </MudMenuItem>
                <MudMenuItem OnClick="@(() => ToggleColumn(nameof(showCategorie)))">
                    <MudIcon Icon="@(showCategorie ? Icons.Material.Filled.CheckBox : Icons.Material.Outlined.CheckBoxOutlineBlank)" Class="mr-2" /> Categorie
                </MudMenuItem>
                <MudMenuItem OnClick="@(() => ToggleColumn(nameof(showClasaRisc)))">
                    <MudIcon Icon="@(showClasaRisc ? Icons.Material.Filled.CheckBox : Icons.Material.Outlined.CheckBoxOutlineBlank)" Class="mr-2" /> Clasa Risc
                </MudMenuItem>
                <MudMenuItem OnClick="@(() => ToggleColumn(nameof(showProducator)))">
                    <MudIcon Icon="@(showProducator ? Icons.Material.Filled.CheckBox : Icons.Material.Outlined.CheckBoxOutlineBlank)" Class="mr-2" /> Producator
                </MudMenuItem>
                <MudMenuItem OnClick="@(() => ToggleColumn(nameof(showModelTip)))">
                    <MudIcon Icon="@(showModelTip ? Icons.Material.Filled.CheckBox : Icons.Material.Outlined.CheckBoxOutlineBlank)" Class="mr-2" /> Model/Tip
                </MudMenuItem>
                <MudMenuItem OnClick="@(() => ToggleColumn(nameof(showCertificareCE)))">
                    <MudIcon Icon="@(showCertificareCE ? Icons.Material.Filled.CheckBox : Icons.Material.Outlined.CheckBoxOutlineBlank)" Class="mr-2" /> CE
                </MudMenuItem>
                <MudMenuItem OnClick="@(() => ToggleColumn(nameof(showDataExpirare)))">
                    <MudIcon Icon="@(showDataExpirare ? Icons.Material.Filled.CheckBox : Icons.Material.Outlined.CheckBoxOutlineBlank)" Class="mr-2" /> Expirare
                </MudMenuItem>
                <MudMenuItem OnClick="@(() => ToggleColumn(nameof(showDataCreare)))">
                    <MudIcon Icon="@(showDataCreare ? Icons.Material.Filled.CheckBox : Icons.Material.Outlined.CheckBoxOutlineBlank)" Class="mr-2" /> Data Creare
                </MudMenuItem>
            </MudMenu>

            <MudButton Variant="Variant.Filled" 
                      Color="Color.Success"
                      StartIcon="@Icons.Material.Filled.Refresh"
                      OnClick="RefreshDataAsync" 
                      Class="mx-2"
                      Disabled="@_loading">
                Reincarca
            </MudButton>
        </ToolBarContent>

        <Columns>
            <HierarchyColumn T="DispozitivMedicalDTO" />
            <PropertyColumn Property="x => x.Id" Title="ID" Hidden="true" />
            <PropertyColumn Property="x => x.Denumire" Title="Denumire" Groupable="true" Sortable="true" Resizable="true" Hidden="@(!showDenumire)" />
            <PropertyColumn Property="x => x.Categorie" Title="Categorie" Groupable="true" Sortable="true" Resizable="true" Hidden="@(!showCategorie)" />
            
            <TemplateColumn Title="Clasa Risc" Groupable="true" Sortable="true" Resizable="true" SortBy="@(x => x.ClasaRisc)" GroupBy="@(x => string.IsNullOrEmpty(x.ClasaRisc) ? "Nespecificat" : $"Clasa {x.ClasaRisc}")" Hidden="@(!showClasaRisc)">
                <CellTemplate>
                    <MudChip Size="Size.Small" Color="@GetClasaRiscColor(context.Item.ClasaRisc)" Variant="Variant.Filled" Dense="true">
                        @(string.IsNullOrEmpty(context.Item.ClasaRisc) ? "N/A" : $"Clasa {context.Item.ClasaRisc}")
                    </MudChip>
                </CellTemplate>
            </TemplateColumn>

            <PropertyColumn Property="x => x.Producator" Title="Producator" Groupable="true" Sortable="true" Resizable="true" Hidden="@(!showProducator)" />
            <PropertyColumn Property="x => x.ModelTip" Title="Model/Tip" Groupable="true" Sortable="true" Resizable="true" Hidden="@(!showModelTip)" />

            <TemplateColumn Title="CE" Groupable="true" Sortable="true" Resizable="true" SortBy="@(x => x.CertificareCE)" GroupBy="@(x => x.CertificareCE ? "Cu Certificare CE" : "Fara Certificare CE")" Hidden="@(!showCertificareCE)">
                <CellTemplate>
                    <MudChip Size="Size.Small" Color="@(context.Item.CertificareCE ? Color.Success : Color.Error)" Variant="Variant.Filled" Dense="true">
                        @(context.Item.CertificareCE ? "DA" : "NU")
                    </MudChip>
                </CellTemplate>
            </TemplateColumn>

            <PropertyColumn Property="x => x.DataExpirare" Title="Expirare" Format="dd.MM.yyyy" Groupable="true" Sortable="true" Resizable="true" Hidden="@(!showDataExpirare)" />
            <PropertyColumn Property="x => x.DataCreare" Title="Data Creare" Format="dd.MM.yyyy" Groupable="true" Sortable="true" Resizable="true" Hidden="@(!showDataCreare)" />

            <TemplateColumn Title="Actiuni" Groupable="false" Sortable="false" Resizable="false">
                <CellTemplate>
                    <div class="d-inline-flex flex-row align-center" style="gap:6px; white-space:nowrap;">
                        <MudIconButton Icon="@Icons.Material.Filled.Visibility" Size="Size.Small" Color="Color.Info" OnClick="@(() => ViewAsync(@context.Item))" Disabled="@_loading" />
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Color="Color.Primary" OnClick="@(() => EditAsync(@context.Item))" Disabled="@_loading" />
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" OnClick="@(() => DeleteAsync(@context.Item))" Disabled="@_loading" />
                    </div>
                </CellTemplate>
            </TemplateColumn>
        </Columns>

        <PagerContent>
            <MudDataGridPager T="DispozitivMedicalDTO" 
                             PageSizeOptions="new int[]{10, 25, 50, 100}" 
                             InfoFormat="@("{first_item}-{last_item} din {all_items}")" />
        </PagerContent>

        <ChildRowContent>
            <MudDataGrid T="DetailRow"
                         Items="@GetDetails(context.Item)"
                         Dense="true"
                         Bordered="true"
                         Hover="true"
                         Hideable="false">
                <Columns>
                    <PropertyColumn Property="d => d.Label" Title="Camp" />
                    <PropertyColumn Property="d => d.Value" Title="Valoare" />
                </Columns>
            </MudDataGrid>
        </ChildRowContent>
    </MudDataGrid>
</MudPaper>

@code {
    private MudDataGrid<DispozitivMedicalDTO> _serverGrid;
    private int _gridKey = 0;
    private int _totalItems;

    private bool showDenumire = true;
    private bool showCategorie = true;
    private bool showClasaRisc = true;
    private bool showProducator = true;
    private bool showModelTip = false;
    private bool showCertificareCE = true;
    private bool showDataExpirare = true;
    private bool showDataCreare = false;

    private bool _loading = false;
    private string _search = string.Empty;
    private string _categorieFilter = "toate";
    private string _clasaRiscFilter = "toate";

    // Grouping variables
    private bool _hasGrouping = true;
    private List<string> _groupedColumns = new();

    private async Task<GridData<DispozitivMedicalDTO>> LoadServerData(GridState<DispozitivMedicalDTO> state)
    {
        try
        {
            _loading = true;
            StateHasChanged();

            // Build sort string from state
            var sortDefinitions = new List<string>();
            foreach (var sortDefinition in state.SortDefinitions)
            {
                var direction = sortDefinition.Descending ? "desc" : "asc";
                sortDefinitions.Add($"{sortDefinition.SortBy}:{direction}");
            }
            var sort = string.Join(",", sortDefinitions);

            // For now, let MudBlazor handle grouping client-side
            // The groupBy parameter will be empty, but server will still sort properly
            var groupBy = string.Empty;

            // Use the new paged grouped method
            var result = await DispozitivMedicalClient.GetPagedGroupedAsync(
                _search, 
                _categorieFilter, 
                _clasaRiscFilter,
                groupBy, 
                sort, 
                state.Page + 1, // MudBlazor uses 0-based pages
                state.PageSize);

            _totalItems = result.TotalCount;

            return new GridData<DispozitivMedicalDTO>
            {
                Items = result.Items,
                TotalItems = result.TotalCount
            };
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Eroare la înc?rcarea datelor: {ex.Message}", Severity.Error);
            return new GridData<DispozitivMedicalDTO> { Items = new List<DispozitivMedicalDTO>(), TotalItems = 0 };
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private async Task OnSearchChanged(string? text)
    {
        _search = text ?? string.Empty;
        await RefreshDataAsync();
    }

    private async Task OnCategorieChanged(string? value)
    {
        _categorieFilter = string.IsNullOrWhiteSpace(value) ? "toate" : value;
        await RefreshDataAsync();
    }

    private async Task OnClasaRiscChanged(string? value)
    {
        _clasaRiscFilter = string.IsNullOrWhiteSpace(value) ? "toate" : value;
        await RefreshDataAsync();
    }

    private async Task ClearFiltersAndReload()
    {
        _search = string.Empty;
        _categorieFilter = "toate";
        _clasaRiscFilter = "toate";
        await RefreshDataAsync();
    }

    private async Task RefreshDataAsync()
    {
        if (_serverGrid != null)
        {
            await _serverGrid.ReloadServerData();
        }
    }

    private void ToggleColumn(string name)
    {
        switch (name)
        {
            case nameof(showDenumire): showDenumire = !showDenumire; break;
            case nameof(showCategorie): showCategorie = !showCategorie; break;
            case nameof(showClasaRisc): showClasaRisc = !showClasaRisc; break;
            case nameof(showProducator): showProducator = !showProducator; break;
            case nameof(showModelTip): showModelTip = !showModelTip; break;
            case nameof(showCertificareCE): showCertificareCE = !showCertificareCE; break;
            case nameof(showDataExpirare): showDataExpirare = !showDataExpirare; break;
            case nameof(showDataCreare): showDataCreare = !showDataCreare; break;
        }
    }

    private Color GetClasaRiscColor(string? clasaRisc) => clasaRisc switch
    {
        "I" => Color.Info,
        "IIa" => Color.Success,
        "IIb" => Color.Warning,
        "III" => Color.Error,
        _ => Color.Default
    };

    private IEnumerable<DetailRow> GetDetails(DispozitivMedicalDTO item)
    {
        if (!string.IsNullOrEmpty(item.NumarSerie))
            yield return new DetailRow("Numar Serie", item.NumarSerie);
        if (!string.IsNullOrEmpty(item.Specificatii))
            yield return new DetailRow("Specificatii", item.Specificatii);
        yield return new DetailRow("Data Creare", item.DataCreare.ToString("dd.MM.yyyy HH:mm"));
        yield return new DetailRow("Data Modificare", item.DataModificare.ToString("dd.MM.yyyy HH:mm"));
        if (item.DataExpirare.HasValue)
            yield return new DetailRow("Data Expirare", item.DataExpirare.Value.ToString("dd.MM.yyyy"));
        yield return new DetailRow("GUID", item.Guid.ToString());
    }
    
    private class DetailRow 
    { 
        public string Label { get; set; } 
        public string Value { get; set; } 
        public DetailRow(string l, string v) { Label = l; Value = v; } 
    }

    private async Task AddAsync() 
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Large, FullWidth = true };
        var dialog = DialogService.Show<AdaugaEditareDispozitivMedicalDialog>("Adauga dispozitiv medical nou", options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            try
            {
                _loading = true;
                StateHasChanged();

                var dispozitivDto = (DispozitivMedicalDTO)result.Data;
                
                var createDto = new CreateDispozitivMedicalDTO
                {
                    Denumire = dispozitivDto.Denumire,
                    Categorie = dispozitivDto.Categorie,
                    ClasaRisc = dispozitivDto.ClasaRisc,
                    Producator = dispozitivDto.Producator,
                    ModelTip = dispozitivDto.ModelTip,
                    NumarSerie = dispozitivDto.NumarSerie,
                    CertificareCE = dispozitivDto.CertificareCE,
                    DataExpirare = dispozitivDto.DataExpirare,
                    Specificatii = dispozitivDto.Specificatii
                };

                var id = await DispozitivMedicalClient.CreateAsync(createDto);

                Snackbar.Add("Dispozitiv medical adaugat cu succes", Severity.Success);
                await RefreshDataAsync();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Eroare la adaugarea dispozitivului medical: {ex.Message}", Severity.Error);
            }
            finally
            {
                _loading = false;
                StateHasChanged();
            }
        }
    }

    private async Task ViewAsync(DispozitivMedicalDTO item) 
    {
        var parameters = new DialogParameters<AdaugaEditareDispozitivMedicalDialog>
        {
            { x => x.Dispozitiv, item },
            { x => x.ReadOnly, true }
        };

        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Large, FullWidth = true };
        var dialog = DialogService.Show<AdaugaEditareDispozitivMedicalDialog>("Detalii dispozitiv medical", parameters, options);
        await dialog.Result;
    }

    private async Task EditAsync(DispozitivMedicalDTO item) 
    {
        var parameters = new DialogParameters<AdaugaEditareDispozitivMedicalDialog>
        {
            { x => x.Dispozitiv, item },
            { x => x.ReadOnly, false }
        };

        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Large, FullWidth = true };
        var dialog = DialogService.Show<AdaugaEditareDispozitivMedicalDialog>("Editare dispozitiv medical", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            try
            {
                _loading = true;
                StateHasChanged();

                var dispozitivDto = (DispozitivMedicalDTO)result.Data;
                
                var updateDto = new UpdateDispozitivMedicalDTO
                {
                    Id = dispozitivDto.Id,
                    Denumire = dispozitivDto.Denumire,
                    Categorie = dispozitivDto.Categorie,
                    ClasaRisc = dispozitivDto.ClasaRisc,
                    Producator = dispozitivDto.Producator,
                    ModelTip = dispozitivDto.ModelTip,
                    NumarSerie = dispozitivDto.NumarSerie,
                    CertificareCE = dispozitivDto.CertificareCE,
                    DataExpirare = dispozitivDto.DataExpirare,
                    Specificatii = dispozitivDto.Specificatii
                };

                var success = await DispozitivMedicalClient.UpdateAsync(updateDto);

                if (success)
                {
                    Snackbar.Add("Dispozitiv medical actualizat cu succes", Severity.Success);
                    await RefreshDataAsync();
                }
                else
                {
                    Snackbar.Add("Actualizarea dispozitivului medical a esuat", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Eroare la actualizarea dispozitivului medical: {ex.Message}", Severity.Error);
            }
            finally
            {
                _loading = false;
                StateHasChanged();
            }
        }
    }

    private async Task DeleteAsync(DispozitivMedicalDTO item) 
    {
        var parameters = new DialogParameters
        {
            { "ContentText", $"Sigur doriti sa stergeti dispozitivul medical '{item.Denumire}'? Aceasta actiune nu poate fi anulata." },
            { "ButtonText", "Sterge" },
            { "Color", Color.Error }
        };

        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.ExtraSmall };
        var dialogResult = await DialogService.Show<ConfirmDialog>("Confirmare stergere", parameters, options).Result;

        if (!dialogResult.Canceled)
        {
            try
            {
                _loading = true;
                StateHasChanged();

                var success = await DispozitivMedicalClient.DeleteAsync(item.Id);

                if (success)
                {
                    Snackbar.Add("Dispozitiv medical sters cu succes", Severity.Success);
                    await RefreshDataAsync();
                }
                else
                {
                    Snackbar.Add("Stergerea dispozitivului medical a esuat", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Eroare la stergerea dispozitivului medical: {ex.Message}", Severity.Error);
            }
            finally
            {
                _loading = false;
                StateHasChanged();
            }
        }
    }

    private void RemoveGrouping(string columnName)
    {
        _groupedColumns.Remove(columnName);
        if (!_groupedColumns.Any())
        {
            _hasGrouping = false;
        }
        StateHasChanged();
    }

    private void ClearAllGrouping()
    {
        _groupedColumns.Clear();
        _hasGrouping = false;
        StateHasChanged();
    }
}
