@page "/administrare/persoane"
@using global::Shared.DTOs.Authentication
@using global::Shared.Common
@using Microsoft.AspNetCore.Components.Authorization
@using Radzen
@using Radzen.Blazor

<PageTitle>Persoane - ValyanMed</PageTitle>

<RadzenStack Orientation="Radzen.Orientation.Vertical" Gap="1rem" Class="p-4 compact">
    
    <!-- Header -->
    <RadzenText TextStyle="TextStyle.H4" Class="mb-3">Persoane</RadzenText>
    
    <!-- Search and Filters -->
    <RadzenCard Class="mb-4">
        <RadzenStack Orientation="Radzen.Orientation.Vertical" Gap="1rem">
            <RadzenRow Gap="1rem">
                <RadzenColumn Size="12" SizeMD="4">
                    <RadzenLabel Text="Cautare globala" />
                    <RadzenTextBox @bind-Value="_searchQuery.Search"
                                   Placeholder="Cautare dupa nume, prenume, email, telefon, CNP..."
                                   @oninput="OnSearchInput"
                                   Style="width: 100%;" />
                </RadzenColumn>
                <RadzenColumn Size="12" SizeMD="3">
                    <RadzenLabel Text="Judet" />
                    <RadzenDropDown @bind-Value="_searchQuery.Judet"
                                    Data="@_judeteOptions"
                                    ValueProperty="Nume"
                                    TextProperty="Nume"
                                    AllowClear="true"
                                    AllowFiltering="true"
                                    Placeholder="Selecteaza judet"
                                    Change="@(async (object value) => await OnJudetChanged(value?.ToString()))"
                                    Style="width: 100%;" />
                </RadzenColumn>
                <RadzenColumn Size="12" SizeMD="3">
                    <RadzenLabel Text="Localitate" />
                    <RadzenDropDown @bind-Value="_searchQuery.Localitate"
                                    Data="@_localitatiOptions"
                                    ValueProperty="Nume"
                                    TextProperty="Nume"
                                    AllowClear="true"
                                    AllowFiltering="true"
                                    Placeholder="Selecteaza localitate"
                                    Change="@OnLocalitateChanged"
                                    Disabled="@(string.IsNullOrEmpty(_searchQuery.Judet))"
                                    Style="width: 100%;" />
                </RadzenColumn>
                <RadzenColumn Size="12" SizeMD="2">
                    <RadzenLabel Text="Status" />
                    <RadzenDropDown @bind-Value="_searchQuery.EsteActiv"
                                    Data="@_statusOptions"
                                    TextProperty="Text"
                                    ValueProperty="Value"
                                    AllowClear="true"
                                    Placeholder="Status"
                                    Change="@OnStatusChanged"
                                    Style="width: 100%;" />
                </RadzenColumn>
            </RadzenRow>

            <RadzenRow>
                <RadzenColumn Size="12">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" JustifyContent="Radzen.JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem">
                            <RadzenButton Text="Reseteaza filtre" 
                                         Icon="clear_all" 
                                         ButtonStyle="ButtonStyle.Warning" 
                                         Variant="Radzen.Variant.Filled"
                                         Size="ButtonSize.Medium"
                                         Click="@ResetFilters" />
                            <RadzenButton Text="Reset Grid" 
                                         Icon="settings_backup_restore" 
                                         ButtonStyle="ButtonStyle.Secondary" 
                                         Variant="Radzen.Variant.Outlined"
                                         Size="ButtonSize.Medium"
                                         Title="Reseteaza setarile grid-ului"
                                         Click="@ResetGridSettings" />
                        </RadzenStack>
                        
                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" AlignItems="Radzen.AlignItems.Center">
                            <RadzenLabel Text="Inregistrari per pagina:" Style="white-space: nowrap;" />
                            <RadzenDropDown @bind-Value="_searchQuery.PageSize"
                                           Data="@_pageSizeOptions"
                                           Change="@OnPageSizeChanged"
                                           Style="width: 100px;"
                                           Variant="Radzen.Variant.Outlined" />
                        </RadzenStack>
                    </RadzenStack>
                </RadzenColumn>
            </RadzenRow>
        </RadzenStack>
    </RadzenCard>

    <!-- Debug info -->
    @if (_isLoading)
    {
        <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Radzen.Variant.Filled">
            Se incarca datele...
        </RadzenAlert>
    }

    <!-- Data Grid -->
    <RadzenCard>
        <RadzenDataGrid @ref="_dataGrid"
                        Data="@_data"
                        Count="@_totalCount"
                        LoadData="@LoadDataAsync"
                        AllowPaging="true"
                        AllowSorting="true"
                        AllowColumnResize="true"
                        AllowColumnReorder="true"
                        PageSize="@_searchQuery.PageSize"
                        PagerHorizontalAlign="Radzen.HorizontalAlign.Left"
                        ShowPagingSummary="true"
                        PagingSummaryFormat="Pagina {0} din {1} ({2} inregistrari)"
                        IsLoading="@_isLoading"
                        ExpandMode="Radzen.DataGridExpandMode.Single"
                        Settings="@_gridSettings"
                        SettingsChanged="@OnSettingsChanged"
                        Density="Radzen.Density.Compact"
                        Style="height: 600px">
            
            <!-- Columns -->
            <Columns>
                <RadzenDataGridColumn Property="NumeComplet" Title="Nume complet" Width="200px" />
                <RadzenDataGridColumn Property="CNP" Title="CNP" Width="150px" />
                <RadzenDataGridColumn Property="DataNasterii" Title="Data nasterii" Width="120px" FormatString="{0:dd.MM.yyyy}" />
                <RadzenDataGridColumn Property="Varsta" Title="Varsta" Width="80px" />
                <RadzenDataGridColumn Property="Gen" Title="Gen" Width="100px" />
                <RadzenDataGridColumn Property="Telefon" Title="Telefon" Width="130px" />
                <RadzenDataGridColumn Property="Email" Title="Email" Width="200px" />
                <RadzenDataGridColumn Property="Judet" Title="Judet" Width="120px" />
                <RadzenDataGridColumn Property="Localitate" Title="Localitate" Width="150px" />
                <RadzenDataGridColumn Property="StatusText" Title="Status" Width="80px">
                    <Template Context="persoana">
                        <RadzenBadge Text="@persoana.StatusText" 
                                     BadgeStyle="@(persoana.EsteActiva ? Radzen.BadgeStyle.Success : Radzen.BadgeStyle.Danger)" 
                                     Variant="Radzen.Variant.Filled" />
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn Property="DataCreare" Title="Data creare" Width="120px" FormatString="{0:dd.MM.yyyy}" />
                <RadzenDataGridColumn Title="Actiuni" Width="120px" Sortable="false" Frozen="true" FrozenPosition="FrozenColumnPosition.Right">
                    <Template Context="persoana">
                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem">
                            <RadzenButton Icon="visibility" 
                                          ButtonStyle="Radzen.ButtonStyle.Primary" 
                                          Variant="Radzen.Variant.Outlined" 
                                          Size="Radzen.ButtonSize.Small"
                                          Title="Vizualizeaza detalii"
                                          Click="@(() => ViewDetails(persoana.Id))" />
                            <RadzenButton Icon="edit" 
                                          ButtonStyle="Radzen.ButtonStyle.Info" 
                                          Variant="Radzen.Variant.Outlined" 
                                          Size="Radzen.ButtonSize.Small"
                                          Title="Editeaza"
                                          Click="@(() => EditPersoana(persoana.Id))" />
                        </RadzenStack>
                    </Template>
                </RadzenDataGridColumn>
            </Columns>

            <!-- Detail Row Template -->
            <Template Context="persoana">
                <RadzenCard Class="m-3 compact">
                    <RadzenRow Gap="2rem">
                        <RadzenColumn Size="12" SizeMD="6">
                            <RadzenText TextStyle="TextStyle.H6" Class="mb-3">
                                <RadzenIcon Icon="person" Class="me-2" />
                                Informatii personale
                            </RadzenText>
                            <RadzenStack Orientation="Radzen.Orientation.Vertical" Gap="0.5rem">
                                <RadzenRow>
                                    <RadzenColumn Size="5"><strong>Nume complet:</strong></RadzenColumn>
                                    <RadzenColumn Size="7">@persoana.NumeComplet</RadzenColumn>
                                </RadzenRow>
                                <RadzenRow>
                                    <RadzenColumn Size="5"><strong>CNP:</strong></RadzenColumn>
                                    <RadzenColumn Size="7">@(persoana.CNP ?? "Nu este specificat")</RadzenColumn>
                                </RadzenRow>
                                <RadzenRow>
                                    <RadzenColumn Size="5"><strong>Data nasterii:</strong></RadzenColumn>
                                    <RadzenColumn Size="7">@persoana.DataNasterii?.ToString("dd.MM.yyyy")</RadzenColumn>
                                </RadzenRow>
                                <RadzenRow>
                                    <RadzenColumn Size="5"><strong>Varsta:</strong></RadzenColumn>
                                    <RadzenColumn Size="7">@persoana.Varsta ani</RadzenColumn>
                                </RadzenRow>
                                <RadzenRow>
                                    <RadzenColumn Size="5"><strong>Gen:</strong></RadzenColumn>
                                    <RadzenColumn Size="7">@persoana.Gen</RadzenColumn>
                                </RadzenRow>
                            </RadzenStack>
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeMD="6">
                            <RadzenText TextStyle="TextStyle.H6" Class="mb-3">
                                <RadzenIcon Icon="contact_phone" Class="me-2" />
                                Contact si locatie
                            </RadzenText>
                            <RadzenStack Orientation="Radzen.Orientation.Vertical" Gap="0.5rem">
                                <RadzenRow>
                                    <RadzenColumn Size="4"><strong>Telefon:</strong></RadzenColumn>
                                    <RadzenColumn Size="8">@(persoana.Telefon ?? "Nu este specificat")</RadzenColumn>
                                </RadzenRow>
                                <RadzenRow>
                                    <RadzenColumn Size="4"><strong>Email:</strong></RadzenColumn>
                                    <RadzenColumn Size="8">@(persoana.Email ?? "Nu este specificat")</RadzenColumn>
                                </RadzenRow>
                                <RadzenRow>
                                    <RadzenColumn Size="4"><strong>Judet:</strong></RadzenColumn>
                                    <RadzenColumn Size="8">@(persoana.Judet ?? "Nu este specificat")</RadzenColumn>
                                </RadzenRow>
                                <RadzenRow>
                                    <RadzenColumn Size="4"><strong>Localitate:</strong></RadzenColumn>
                                    <RadzenColumn Size="8">@(persoana.Localitate ?? "Nu este specificata")</RadzenColumn>
                                </RadzenRow>
                                <RadzenRow>
                                    <RadzenColumn Size="4"><strong>Adresa:</strong></RadzenColumn>
                                    <RadzenColumn Size="8">@(persoana.Adresa ?? "Nu este specificata")</RadzenColumn>
                                </RadzenRow>
                                <RadzenRow>
                                    <RadzenColumn Size="4"><strong>Status:</strong></RadzenColumn>
                                    <RadzenColumn Size="8">
                                        <RadzenBadge Text="@persoana.StatusText" 
                                                     BadgeStyle="@(persoana.EsteActiva ? Radzen.BadgeStyle.Success : Radzen.BadgeStyle.Danger)" 
                                                     Variant="Radzen.Variant.Filled" />
                                    </RadzenColumn>
                                </RadzenRow>
                                <RadzenRow>
                                    <RadzenColumn Size="4"><strong>Data creare:</strong></RadzenColumn>
                                    <RadzenColumn Size="8">@persoana.DataCreare?.ToString("dd.MM.yyyy HH:mm")</RadzenColumn>
                                </RadzenRow>
                            </RadzenStack>
                        </RadzenColumn>
                    </RadzenRow>
                </RadzenCard>
            </Template>
        </RadzenDataGrid>
    </RadzenCard>
</RadzenStack>