@page "/administrare/utilizatori"
@using global::Shared.Models.Authentication
@using global::Shared.Common
@using Radzen
@using Radzen.Blazor
@inherits UtilizatoriBase

<PageTitle>Gestionare Utilizatori - ValyanMed</PageTitle>

<RadzenStack Orientation="Radzen.Orientation.Vertical" Gap="1rem" Class="p-4">
    
    <!-- Header Card - FOLOSESTE CLASELE GLOBALE -->
    <RadzenCard Class="page-header-card list-mode">
        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="1rem">
            <RadzenIcon Icon="manage_accounts" Class="page-header-icon list-mode" />
            <RadzenText TextStyle="TextStyle.H4" Class="page-header-title list-mode">
                Gestionare Utilizatori
            </RadzenText>
        </RadzenStack>
    </RadzenCard>

    <!-- Header Actions -->
    <RadzenCard Class="action-buttons-card">
        <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
            <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="1rem" AlignItems="Radzen.AlignItems.End">
                <!-- Search Box -->
                <RadzenFormField Text="Cautare rapida" Style="width: 300px;">
                    <RadzenTextBox @bind-Value="State.SearchTerm"
                                   Placeholder="Cauta utilizatori..."
                                   @oninput="@(async (ChangeEventArgs e) => await OnSearchChanged(e.Value?.ToString() ?? string.Empty))"
                                   Style="width: 100%;" />
                </RadzenFormField>
                
                <RadzenButton Text="Expandeaza toate" 
                             Icon="expand_more" 
                             ButtonStyle="ButtonStyle.Light" 
                             Variant="Radzen.Variant.Outlined"
                             Click="@ExpandAllRows" />
                             
                <RadzenButton Text="Comprima toate" 
                             Icon="expand_less" 
                             ButtonStyle="ButtonStyle.Light" 
                             Variant="Radzen.Variant.Outlined"
                             Click="@CollapseAllRows" />
                             
                <RadzenButton Text="Reseteaza filtre" 
                             Icon="clear_all" 
                             ButtonStyle="ButtonStyle.Warning" 
                             Variant="Radzen.Variant.Filled"
                             Size="ButtonSize.Medium"
                             Class="reset-button"
                             Click="@ResetFilters" />

                <RadzenButton Text="Reset Grid" 
                             Icon="settings_backup_restore" 
                             ButtonStyle="ButtonStyle.Secondary" 
                             Variant="Radzen.Variant.Outlined"
                             Size="ButtonSize.Medium"
                             Title="Reseteaza setarile grid-ului"
                             Click="@ResetGridSettings" />
            </RadzenStack>
            
            <RadzenButton Text="ADAUGA UTILIZATOR NOU" 
                         Icon="person_add" 
                         ButtonStyle="ButtonStyle.Success" 
                         Variant="Radzen.Variant.Filled"
                         Size="ButtonSize.Large"
                         Class="primary-action-button"
                         Click="@CreateNewUser" />
        </RadzenStack>
    </RadzenCard>

    <!-- Loading State -->
    @if (State.IsLoading)
    {
        <RadzenCard>
            <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.Center" AlignItems="Radzen.AlignItems.Center" Gap="1rem" Class="loading-container">
                <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
                <RadzenStack Orientation="Radzen.Orientation.Vertical" AlignItems="Radzen.AlignItems.Start" Gap="0.5rem">
                    <RadzenText TextStyle="TextStyle.Body1">Se incarca utilizatorii...</RadzenText>
                    <RadzenText TextStyle="TextStyle.Body2" Class="text-muted">
                        Va rugam sa asteptati...
                    </RadzenText>
                </RadzenStack>
            </RadzenStack>
        </RadzenCard>
    }
    else
    {
        <!-- Data Grid cu Settings Persistence -->
        <RadzenCard>
            <RadzenDataGrid @ref="_dataGrid"
                            TItem="Utilizator"
                            class="utilizatori-grid"
                            Data="@State.FilteredUsers"
                            AllowPaging="false"
                            AllowSorting="true"
                            AllowColumnResize="true"
                            AllowFiltering="false"
                            AllowGrouping="true"
                            ShowPagingSummary="false"
                            IsLoading="@State.IsLoading"
                            ExpandMode="Radzen.DataGridExpandMode.Multiple"
                            AllowRowSelectOnRowClick="false"
                            Settings="@_gridSettings"
                            SettingsChanged="@OnSettingsChanged">

                <Columns>
                    <Radzen.Blazor.RadzenDataGridColumn TItem="Utilizator" Property="NumeUtilizator" Title="Nume Utilizator" Width="200px" Sortable="true" Groupable="true" />
                    <Radzen.Blazor.RadzenDataGridColumn TItem="Utilizator" Property="Email" Title="Email" Width="250px" Sortable="true" Groupable="true" />
                    <Radzen.Blazor.RadzenDataGridColumn TItem="Utilizator" Property="Telefon" Title="Telefon" Width="150px" Sortable="true" Groupable="true">
                        <Template Context="utilizator">@(utilizator.Telefon ?? "Nu este specificat")</Template>
                    </Radzen.Blazor.RadzenDataGridColumn>
                    <Radzen.Blazor.RadzenDataGridColumn TItem="Utilizator" Property="EsteActiv" Title="Status" Width="100px" Sortable="true" Groupable="true">
                        <Template Context="utilizator">
                            <RadzenBadge Text="@(utilizator.EsteActiv ? "Activ" : "Inactiv")" 
                                         BadgeStyle="@(utilizator.EsteActiv ? Radzen.BadgeStyle.Success : Radzen.BadgeStyle.Secondary)" 
                                         Variant="Radzen.Variant.Filled"
                                         Class="status-badge" />
                        </Template>
                    </Radzen.Blazor.RadzenDataGridColumn>
                    <Radzen.Blazor.RadzenDataGridColumn TItem="Utilizator" Property="DataCreare" Title="Data Crearii" Width="130px" Sortable="true" FormatString="{0:dd.MM.yyyy}" />
                    <Radzen.Blazor.RadzenDataGridColumn TItem="Utilizator" Title="Actiuni" Width="220px" Sortable="false" Filterable="false" Groupable="false">
                        <Template Context="utilizator">
                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem">
                                <RadzenButton Icon="visibility" 
                                            ButtonStyle="ButtonStyle.Success" 
                                            Variant="Radzen.Variant.Outlined" 
                                            Size="ButtonSize.Small" 
                                            Title="Vizualizeaza" 
                                            Click="@(() => ViewUser(utilizator))" />
                                <RadzenButton Icon="edit" 
                                            ButtonStyle="ButtonStyle.Info" 
                                            Variant="Radzen.Variant.Outlined" 
                                            Size="ButtonSize.Small" 
                                            Title="Editeaza" 
                                            Click="@(() => EditUser(utilizator))" />
                                <RadzenButton Icon="delete" 
                                            ButtonStyle="ButtonStyle.Danger" 
                                            Variant="Radzen.Variant.Outlined" 
                                            Size="ButtonSize.Small" 
                                            Title="Sterge" 
                                            Click="@(() => DeleteUser(utilizator))" />
                            </RadzenStack>
                        </Template>
                    </Radzen.Blazor.RadzenDataGridColumn>
                </Columns>

                <!-- Master-Detail Template pentru fiecare rând -->
                <Template Context="utilizator">
                    <RadzenCard Class="detail-card">
                        <RadzenStack Orientation="Radzen.Orientation.Vertical" Gap="1.5rem">
                            
                            <!-- Header Detail -->
                            <RadzenRow>
                                <RadzenColumn Size="12">
                                    <RadzenText TextStyle="TextStyle.H5" Class="detail-header-title">
                                        <RadzenIcon Icon="badge" Class="detail-header-icon" />
                                        Detalii Complete - @utilizator.NumeUtilizator
                                    </RadzenText>
                                </RadzenColumn>
                            </RadzenRow>

                            <!-- Main Details Row -->
                            <RadzenRow Gap="2rem">
                                <!-- User Information -->
                                <RadzenColumn Size="12" SizeMD="6">
                                    <RadzenCard Class="info-section-card">
                                        <RadzenText TextStyle="TextStyle.H6" Class="info-section-title">
                                            <RadzenIcon Icon="person" Class="info-section-icon personal-icon" />
                                            Informatii Utilizator
                                        </RadzenText>
                                        <RadzenStack Orientation="Radzen.Orientation.Vertical" Gap="0.8rem">
                                            <RadzenRow>
                                                <RadzenColumn Size="5"><strong>Nume utilizator:</strong></RadzenColumn>
                                                <RadzenColumn Size="7">@utilizator.NumeUtilizator</RadzenColumn>
                                            </RadzenRow>
                                            <RadzenRow>
                                                <RadzenColumn Size="5"><strong>Email:</strong></RadzenColumn>
                                                <RadzenColumn Size="7">
                                                    <RadzenLink Text="@utilizator.Email" Path="@($"mailto:{utilizator.Email}")" />
                                                </RadzenColumn>
                                            </RadzenRow>
                                            <RadzenRow>
                                                <RadzenColumn Size="5"><strong>Telefon:</strong></RadzenColumn>
                                                <RadzenColumn Size="7">
                                                    @if (!string.IsNullOrEmpty(utilizator.Telefon))
                                                    {
                                                        <RadzenLink Text="@utilizator.Telefon" Path="@($"tel:{utilizator.Telefon}")" />
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted">Nu este specificat</span>
                                                    }
                                                </RadzenColumn>
                                            </RadzenRow>
                                            <RadzenRow>
                                                <RadzenColumn Size="5"><strong>Status:</strong></RadzenColumn>
                                                <RadzenColumn Size="7">
                                                    <RadzenBadge Text="@(utilizator.EsteActiv ? "ACTIV" : "INACTIV")" 
                                                               BadgeStyle="@(utilizator.EsteActiv ? Radzen.BadgeStyle.Success : Radzen.BadgeStyle.Danger)" 
                                                               Variant="Radzen.Variant.Filled"
                                                               Class="status-badge-large" />
                                                </RadzenColumn>
                                            </RadzenRow>
                                        </RadzenStack>
                                    </RadzenCard>
                                </RadzenColumn>

                                <!-- Additional Information -->
                                <RadzenColumn Size="12" SizeMD="6">
                                    <RadzenCard Class="info-section-card">
                                        <RadzenText TextStyle="TextStyle.H6" Class="info-section-title">
                                            <RadzenIcon Icon="info" Class="info-section-icon contact-icon" />
                                            Informatii Suplimentare
                                        </RadzenText>
                                        <RadzenStack Orientation="Radzen.Orientation.Vertical" Gap="0.8rem">
                                            <RadzenRow>
                                                <RadzenColumn Size="4"><strong>ID:</strong></RadzenColumn>
                                                <RadzenColumn Size="8">@utilizator.Id</RadzenColumn>
                                            </RadzenRow>
                                            <RadzenRow>
                                                <RadzenColumn Size="4"><strong>Data crearii:</strong></RadzenColumn>
                                                <RadzenColumn Size="8">
                                                    <RadzenText TextStyle="TextStyle.Body2">
                                                        @(utilizator.DataCreare?.ToString("dd.MM.yyyy") ?? "Nu este specificata")
                                                    </RadzenText>
                                                </RadzenColumn>
                                            </RadzenRow>
                                        </RadzenStack>
                                    </RadzenCard>
                                </RadzenColumn>
                            </RadzenRow>

                            <!-- Action Buttons -->
                            <RadzenRow>
                                <RadzenColumn Size="12" Class="text-end">
                                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="1rem">
                                        <RadzenButton Text="Vizualizeaza Complet" 
                                                    Icon="launch" 
                                                    ButtonStyle="ButtonStyle.Info"
                                                    Click="@(() => ViewUser(utilizator))" />
                                        <RadzenButton Text="Editeaza" 
                                                    Icon="edit" 
                                                    ButtonStyle="ButtonStyle.Secondary"
                                                    Click="@(() => EditUser(utilizator))" />
                                        <RadzenButton Text="Sterge" 
                                                    Icon="delete" 
                                                    ButtonStyle="ButtonStyle.Danger"
                                                    Click="@(() => DeleteUser(utilizator))" />
                                    </RadzenStack>
                                </RadzenColumn>
                            </RadzenRow>

                        </RadzenStack>
                    </RadzenCard>
                </Template>

                <!-- No Records Content -->
                <EmptyTemplate>
                    <RadzenStack AlignItems="Radzen.AlignItems.Center" Gap="1rem" Class="loading-container">
                        <RadzenIcon Icon="manage_accounts" Class="empty-icon" />
                        <RadzenText TextStyle="TextStyle.H5" Class="text-muted">
                            @if (string.IsNullOrEmpty(State.SearchTerm))
                            {
                                <text>Nu au fost gasiti utilizatori</text>
                            }
                            else
                            {
                                <text>Nu au fost gasiti utilizatori care sa corespunda criteriilor de cautare</text>
                            }
                        </RadzenText>
                        @if (!string.IsNullOrEmpty(State.SearchTerm))
                        {
                            <RadzenButton Text="Reseteaza filtrele" 
                                         Icon="clear_all" 
                                         ButtonStyle="ButtonStyle.Primary" 
                                         Click="@ResetFilters" />
                        }
                    </RadzenStack>
                </EmptyTemplate>
            </RadzenDataGrid>
        </RadzenCard>
    }
</RadzenStack>

@code {
    private Radzen.Blazor.RadzenDataGrid<Utilizator> _dataGrid = null!;
}