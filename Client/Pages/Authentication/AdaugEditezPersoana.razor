@page "/administrare/persoane/nou"
@page "/administrare/persoane/editare/{PersoanaId:int}"
@using global::Shared.DTOs.Authentication
@using global::Shared.Common
@using Radzen
@using Radzen.Blazor
@using FluentValidation

<PageTitle>@(_isEditMode ? "Modifica Persoana" : "Adauga Persoana") - ValyanMed</PageTitle>

<div class="page-container">
    <!-- Header Card - APLIC?M STILUL COMPACT -->
    <div class="compact" style="padding: 1rem 1rem 0 1rem; flex-shrink: 0;">
        <RadzenCard Class="page-header-card edit-mode rz-mb-2">
            <RadzenRow JustifyContent="Radzen.JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                <RadzenColumn Size="12" SizeMD="8">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.25rem">
                        <RadzenIcon Icon="@(_isEditMode ? "edit" : "person_add")" Class="page-header-icon edit-mode" />
                        <RadzenText TextStyle="TextStyle.H5" Class="page-header-title edit-mode rz-m-0">
                            @(_isEditMode ? "Modifica Persoana" : "Adauga Persoana Noua")
                        </RadzenText>
                    </RadzenStack>
                </RadzenColumn>
                <RadzenColumn Size="12" SizeMD="4">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="Radzen.JustifyContent.End" Gap="0.25rem">
                        <RadzenButton Text="Inapoi la lista" 
                                     Icon="arrow_back" 
                                     ButtonStyle="ButtonStyle.Info" 
                                     Variant="Radzen.Variant.Filled"
                                     Size="ButtonSize.Small"
                                     Class="back-button"
                                     Click="@BackToList"
                                     Disabled="@_isProcessing" />
                    </RadzenStack>
                </RadzenColumn>
            </RadzenRow>
        </RadzenCard>
    </div>

    <!-- Scrollable Content Area - ACEST DIV VA AVEA SCROLL PRIN CSS -->
    <div style="padding: 0 1rem 1rem 1rem;">
        <!-- Loading State -->
        @if (_isLoading)
        {
            <RadzenCard Class="rz-p-4">
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="Radzen.JustifyContent.Center" AlignItems="Radzen.AlignItems.Center" Gap="1rem">
                    <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Medium" />
                    <RadzenStack Orientation="Radzen.Orientation.Vertical" AlignItems="Radzen.AlignItems.Start" Gap="0.5rem">
                        <RadzenText TextStyle="TextStyle.Body2">
                            @(_isEditMode ? "Se incarca datele persoanei..." : "Se initializeaza formularul...")
                        </RadzenText>
                        <RadzenText TextStyle="TextStyle.Caption" Class="text-muted">
                            Va rugam sa asteptati...
                        </RadzenText>
                    </RadzenStack>
                </RadzenStack>
            </RadzenCard>
        }
        else
        {
            <!-- Main Content Container -->
            <RadzenCard Class="form-container">
                <div class="form-content-wrapper" style="padding: 1rem;">
                    <RadzenTemplateForm TItem="CreatePersoanaRequest" Data="@_model" Submit="@OnSubmitAsync" InvalidSubmit="@OnInvalidSubmit">
                        <DataAnnotationsValidator />
                        
                        <!-- Formularul principal -->
                        <RadzenStack Gap="2rem">
                            
                            <!-- Informatii Personale -->
                            <RadzenFieldset Text="Informatii Personale">
                                <RadzenRow Gap="1rem" RowGap="1.5rem">
                                    <!-- Nume -->
                                    <RadzenColumn Size="12" SizeMD="6">
                                        <RadzenText TextStyle="TextStyle.Body2" Class="rz-mb-2">
                                            Nume <span Class="required-field">*</span>
                                        </RadzenText>
                                        <RadzenTextBox @bind-Value="_model.Nume" 
                                                      Name="Nume"
                                                      Placeholder="Introduceti numele..." 
                                                      MaxLength="100"
                                                      Style="width: 100%;"
                                                      Variant="Radzen.Variant.Outlined"
                                                      Change="@(() => OnFieldChanged(nameof(_model.Nume)))"
                                                      @oninput="@(() => OnFieldChanged(nameof(_model.Nume)))"
                                                      Disabled="@_isProcessing" />
                                        <RadzenRequiredValidator Component="Nume" Text="Numele este obligatoriu" />
                                    </RadzenColumn>
                                    
                                    <!-- Prenume -->
                                    <RadzenColumn Size="12" SizeMD="6">
                                        <RadzenText TextStyle="TextStyle.Body2" Class="rz-mb-2">
                                            Prenume <span class="required-field">*</span>
                                        </RadzenText>
                                        <RadzenTextBox @bind-Value="_model.Prenume" 
                                                      Name="Prenume"
                                                      Placeholder="Introduceti prenumele..." 
                                                      MaxLength="100"
                                                      Style="width: 100%;"
                                                      Variant="Radzen.Variant.Outlined"
                                                      Change="@(() => OnFieldChanged(nameof(_model.Prenume)))"
                                                      @oninput="@(() => OnFieldChanged(nameof(_model.Prenume)))"
                                                      Disabled="@_isProcessing" />
                                        <RadzenRequiredValidator Component="Prenume" Text="Prenumele este obligatoriu" />
                                    </RadzenColumn>
                                    
                                    <!-- CNP -->
                                    <RadzenColumn Size="12" SizeMD="6">
                                        <RadzenText TextStyle="TextStyle.Body2" Class="rz-mb-2">
                                            CNP
                                        </RadzenText>
                                        <RadzenTextBox @bind-Value="_model.CNP" 
                                                      Name="CNP"
                                                      Placeholder="Introduceti CNP-ul..." 
                                                      MaxLength="13"
                                                      Style="width: 100%;"
                                                      Variant="Radzen.Variant.Outlined"
                                                      Change="@(() => OnFieldChanged(nameof(_model.CNP)))"
                                                      @oninput="@(() => OnFieldChanged(nameof(_model.CNP)))"
                                                      @onblur="@OnCnpBlur"
                                                      Disabled="@_isProcessing" />
                                        <RadzenText TextStyle="TextStyle.Caption" Class="text-muted">
                                            CNP-ul va fi verificat automat la completare pentru validare ?i existen?a în sistem
                                        </RadzenText>
                                    </RadzenColumn>

                                    <!-- Data Nasterii -->
                                    <RadzenColumn Size="12" SizeMD="6">
                                        <RadzenText TextStyle="TextStyle.Body2" Class="rz-mb-2">
                                            Data nasterii <span class="required-field">*</span>
                                        </RadzenText>
                                        <RadzenDatePicker @bind-Value="_model.DataNasterii" 
                                                         Name="DataNasterii"
                                                         Placeholder="Selecteaza data nasterii..."
                                                         ShowTime="false"
                                                         DateFormat="dd.MM.yyyy"
                                                         Style="width: 100%;"
                                                         Variant="Radzen.Variant.Outlined"
                                                         Change="@(() => OnFieldChanged(nameof(_model.DataNasterii)))"
                                                         Disabled="@_isProcessing" />
                                        <RadzenRequiredValidator Component="DataNasterii" Text="Data nasterii este obligatorie" />
                                    </RadzenColumn>

                                    <!-- Gen -->
                                    <RadzenColumn Size="12" SizeMD="6">
                                        <RadzenText TextStyle="TextStyle.Body2" Class="rz-mb-2">
                                            Gen <span class="required-field">*</span>
                                        </RadzenText>
                                        <RadzenDropDown @bind-Value="_model.Gen" 
                                                       Name="Gen"
                                                       Data="@_genOptions" 
                                                       Placeholder="Selecteaza genul..." 
                                                       AllowClear="false"
                                                       Style="width: 100%;"
                                                       Variant="Radzen.Variant.Outlined"
                                                       Change="@(() => OnFieldChanged(nameof(_model.Gen)))"
                                                       Disabled="@_isProcessing">
                                            <Template Context="genItem">
                                                @{
                                                    var genValue = (Gen)genItem;
                                                    var description = genValue switch
                                                    {
                                                        Gen.Masculin => "Masculin",
                                                        Gen.Feminin => "Feminin", 
                                                        Gen.Neprecizat => "Neprecizat",
                                                        _ => genItem.ToString()
                                                    };
                                                }
                                                @description
                                            </Template>
                                        </RadzenDropDown>
                                        <RadzenRequiredValidator Component="Gen" Text="Genul este obligatoriu" />
                                    </RadzenColumn>

                                    <!-- Status -->
                                    <RadzenColumn Size="12" SizeMD="6">
                                        <RadzenText TextStyle="TextStyle.Body2" Class="rz-mb-2">Status</RadzenText>
                                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem" 
                                                   Class="status-container">
                                            <RadzenCheckBox @bind-Value="_model.EsteActiva" 
                                                           Name="EsteActiva"
                                                           @bind-Value:after="@(() => OnFieldChanged(nameof(_model.EsteActiva)))"
                                                           Disabled="@_isProcessing" />
                                            <RadzenLabel Text="Persoana activa in sistem" Component="EsteActiva" />
                                        </RadzenStack>
                                    </RadzenColumn>
                                </RadzenRow>
                            </RadzenFieldset>

                            <!-- Informatii Contact -->
                            <RadzenFieldset Text="Informatii de Contact">
                                <RadzenRow Gap="1rem" RowGap="1.5rem">
                                    <!-- Telefon -->
                                    <RadzenColumn Size="12" SizeMD="6">
                                        <RadzenText TextStyle="TextStyle.Body2" Class="rz-mb-2">
                                            Telefon
                                        </RadzenText>
                                        <RadzenTextBox @bind-Value="_model.Telefon" 
                                                      Name="Telefon"
                                                      Placeholder="Ex: 0721123456" 
                                                      MaxLength="20"
                                                      Style="width: 100%;"
                                                      Variant="Radzen.Variant.Outlined"
                                                      Change="@(() => OnFieldChanged(nameof(_model.Telefon)))"
                                                      @oninput="@(() => OnFieldChanged(nameof(_model.Telefon)))"
                                                      Disabled="@_isProcessing" />
                                    </RadzenColumn>

                                    <!-- Email -->
                                    <RadzenColumn Size="12" SizeMD="6">
                                        <RadzenText TextStyle="TextStyle.Body2" Class="rz-mb-2">
                                            Email
                                        </RadzenText>
                                        <RadzenTextBox @bind-Value="_model.Email" 
                                                      Name="Email"
                                                      Placeholder="Ex: nume@email.ro" 
                                                      MaxLength="100"
                                                      Style="width: 100%;"
                                                      Variant="Radzen.Variant.Outlined"
                                                      Change="@(() => OnFieldChanged(nameof(_model.Email)))"
                                                      @oninput="@(() => OnFieldChanged(nameof(_model.Email)))"
                                                      Disabled="@_isProcessing" />
                                        <RadzenEmailValidator Component="Email" Text="Formatul email-ului nu este valid" />
                                    </RadzenColumn>
                                </RadzenRow>
                            </RadzenFieldset>

                            <!-- Informatii Locatie -->
                            <RadzenFieldset Text="Informatii de Locatie">
                                <RadzenRow Gap="1rem" RowGap="1.5rem">
                                    <!-- Judet -->
                                    <RadzenColumn Size="12" SizeMD="6">
                                        <RadzenText TextStyle="TextStyle.Body2" Class="rz-mb-2">Judet</RadzenText>
                                        <RadzenDropDown @bind-Value="_model.Judet" 
                                                       Name="Judet"
                                                       Data="@_judeteOptions" 
                                                       ValueProperty="Nume"
                                                       TextProperty="Nume"
                                                       Placeholder="Selecteaza judetul..." 
                                                       AllowClear="true"
                                                       AllowFiltering="true"
                                                       Style="width: 100%;"
                                                       Variant="Radzen.Variant.Outlined"
                                                       Change="@OnJudetChanged"
                                                       Disabled="@_isProcessing" />
                                    </RadzenColumn>

                                    <!-- Localitate -->
                                    <RadzenColumn Size="12" SizeMD="6">
                                        <RadzenText TextStyle="TextStyle.Body2" Class="rz-mb-2">Localitate</RadzenText>
                                        <RadzenDropDown @bind-Value="_model.Localitate" 
                                                       Name="Localitate"
                                                       Data="@_localitatiOptions" 
                                                       ValueProperty="Nume"
                                                       TextProperty="Nume"
                                                       Placeholder="Selecteaza localitatea..." 
                                                       AllowClear="true"
                                                       AllowFiltering="true"
                                                       Style="width: 100%;"
                                                       Variant="Radzen.Variant.Outlined"
                                                       Disabled="@(string.IsNullOrEmpty(_model.Judet) || _isProcessing)"
                                                       Change="@(() => OnFieldChanged(nameof(_model.Localitate)))" />
                                    </RadzenColumn>

                                    <!-- Adresa -->
                                    <RadzenColumn Size="12">
                                        <RadzenText TextStyle="TextStyle.Body2" Class="rz-mb-2">Adresa</RadzenText>
                                        <RadzenTextArea @bind-Value="_model.Adresa" 
                                                       Name="Adresa"
                                                       Placeholder="Introduceti adresa completa..." 
                                                       MaxLength="500"
                                                       Rows="3"
                                                       Style="width: 100%;"
                                                       Variant="Radzen.Variant.Outlined"
                                                       Change="@(() => OnFieldChanged(nameof(_model.Adresa)))"
                                                       Disabled="@_isProcessing" />
                                    </RadzenColumn>
                                </RadzenRow>
                            </RadzenFieldset>

                            <!-- Action Buttons Section - APLIC?M STILUL COMPACT ?I MUT?M ÎN FORMULAR -->
                            <div class="compact">
                                <RadzenFieldset Class="actions-bar" style="margin-top: 2rem; margin-bottom: 2rem;">
                                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="Radzen.JustifyContent.End" Gap="0.25rem" 
                                               Wrap="Radzen.FlexWrap.Wrap" AlignItems="Radzen.AlignItems.Center">
                                        <RadzenButton Text="Anuleaza" 
                                                     Icon="cancel" 
                                                     ButtonStyle="ButtonStyle.Danger" 
                                                     Variant="Radzen.Variant.Outlined"
                                                     Size="ButtonSize.Small"
                                                     Class="cancel-button"
                                                     Click="@BackToList"
                                                     Disabled="@_isProcessing" />
                                                     
                                        <RadzenButton ButtonType="Radzen.ButtonType.Submit" 
                                                     Text="@GetSaveButtonText()" 
                                                     Icon="@GetSaveButtonIcon()" 
                                                     ButtonStyle="ButtonStyle.Success" 
                                                     Variant="Radzen.Variant.Filled"
                                                     Size="ButtonSize.Small"
                                                     Class="save-button"
                                                     Disabled="@_isProcessing"
                                                     IsBusy="@_isProcessing"
                                                     Click="@(async () => await OnSubmitAsync(_model))" />
                                    </RadzenStack>
                                </RadzenFieldset>
                            </div>
                        </RadzenStack>
                    </RadzenTemplateForm>
                </div>
            </RadzenCard>
        }
    </div>
</div>

<!-- Processing Overlay - CU DEBUG LOGGING -->
@if (_isProcessing)
{
    <div class="processing-overlay">
        <div class="processing-content">
            <RadzenCard Class="processing-dialog">
                <RadzenStack Gap="1rem">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="Radzen.JustifyContent.Center" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
                        <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Medium" />
                        <RadzenStack Orientation="Radzen.Orientation.Vertical" AlignItems="Radzen.AlignItems.Start" Gap="0.5rem">
                            <RadzenText TextStyle="TextStyle.Body1" Class="text-primary">
                                @(_isEditMode ? "Se actualizeaza..." : "Se salveaza...")
                            </RadzenText>
                            <RadzenText TextStyle="TextStyle.Caption" Class="text-muted">
                                Procesarea datelor in curs... Va rugam sa asteptati.
                            </RadzenText>
                        </RadzenStack>
                    </RadzenStack>
                    
                    <!-- Emergency Cancel Button -->
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="Radzen.JustifyContent.Center">
                        <RadzenButton Text="Anuleaza operatiunea" 
                                     Icon="close" 
                                     ButtonStyle="ButtonStyle.Light" 
                                     Variant="Radzen.Variant.Outlined"
                                     Size="ButtonSize.Small"
                                     Class="emergency-cancel-button"
                                     Click="@CancelProcessing"
                                     Style="opacity: 0.7;" />
                    </RadzenStack>
                </RadzenStack>
            </RadzenCard>
        </div>
    </div>
}