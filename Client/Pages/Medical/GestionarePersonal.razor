@page "/medical/gestionare-personal"
@using global::Shared.DTOs.Medical
@using global::Shared.Common
@using Microsoft.AspNetCore.Components.Authorization
@using Radzen
@using Radzen.Blazor
@using Client.Services.Medical

<PageTitle>Gestionare Personal Medical - ValyanMed</PageTitle>

<RadzenStack Orientation="Radzen.Orientation.Vertical" Gap="0.5rem" Class="p-3 compact">
    
    <!-- Header - FOLOSESTE CLASELE GLOBALE -->
    <RadzenCard Class="page-header-card list-mode">
        <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
            <RadzenIcon Icon="groups" Class="page-header-icon list-mode" />
            <RadzenText TextStyle="TextStyle.H5" Class="page-header-title list-mode">
                Gestionare Personal Medical
            </RadzenText>
        </RadzenStack>
    </RadzenCard>
    
    <!-- Header Actions - ÎMBUNĂTĂȚIT PENTRU VIZIBILITATE -->
    <RadzenCard Class="action-buttons-card">
        <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center" Gap="0.5rem">
            <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" AlignItems="Radzen.AlignItems.End">
                <RadzenFormField Text="Cautare rapida" Style="width: 260px;">
                    <RadzenTextBox @bind-Value="_searchQuery.Search"
                                   Placeholder="Cauta personal..."
                                   @oninput="OnSearchInput"
                                   Style="width: 100%;" />
                </RadzenFormField>
                
                <!-- BUTON RESETEAZĂ FILTRE - ÎMBUNĂTĂȚIT -->
                <RadzenButton Text="Resetează filtre" 
                             Icon="clear_all" 
                             ButtonStyle="ButtonStyle.Warning" 
                             Variant="Radzen.Variant.Filled"
                             Size="ButtonSize.Small"
                             Class="reset-button"
                             Click="@ResetFilters" />

                <!-- BUTON RESET GRID SETTINGS -->
                <RadzenButton Text="Reset Grid" 
                             Icon="settings_backup_restore" 
                             ButtonStyle="ButtonStyle.Secondary" 
                             Variant="Radzen.Variant.Outlined"
                             Size="ButtonSize.Small"
                             Title="Reseteaza setarile grid-ului"
                             Click="@ResetGridSettings" />
            </RadzenStack>
            
            <!-- BUTON ADAUGĂ PERSONAL NOU - ÎMBUNĂTĂȚIT -->
            <RadzenButton Text="ADAUGA PERSONAL NOU" 
                         Icon="person_add" 
                         ButtonStyle="ButtonStyle.Success" 
                         Variant="Radzen.Variant.Filled"
                         Size="ButtonSize.Medium"
                         Class="primary-action-button"
                         Click="@CreateNewPersonal" />
        </RadzenStack>
    </RadzenCard>

    <!-- Data Grid -->
    <RadzenCard>
        @if (_isGrouped && _currentGroups.Any())
        {
            <!-- Informații despre grupare -->
            <RadzenCard Class="grouping-info-card">
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" AlignItems="Radzen.AlignItems.Center">
                        <RadzenIcon Icon="view_module" Class="grouping-icon" />
                        <RadzenText TextStyle="TextStyle.Body2">
                            <strong>Grupat dupa:</strong> @string.Join(", ", _currentGroups.Select(g => g.Property))
                        </RadzenText>
                        <RadzenCheckBox @bind-Value="_allGroupsExpanded" 
                                       Name="allGroupsExpanded" 
                                       TValue="bool" 
                                       Change="@OnAllGroupsExpandedChange" />
                        <RadzenLabel Text="Toate grupurile expandate" Component="allGroupsExpanded" Class="grouping-label" />
                    </RadzenStack>
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.5rem" AlignItems="Radzen.AlignItems.Center">
                        <RadzenButton Icon="clear" 
                                     ButtonStyle="ButtonStyle.Light" 
                                     Variant="Radzen.Variant.Text" 
                                     Size="ButtonSize.Small"
                                     Title="Elimina gruparea"
                                     Click="@ClearGrouping" />
                    </RadzenStack>
                </RadzenStack>
            </RadzenCard>
        }

        <RadzenDataGrid @ref="_dataGrid"
                        TItem="PersonalMedicalListDto"
                        class="personal-grid"
                        Data="@_data"
                        Count="@_totalCount"
                        LoadData="@LoadDataAsync"
                        Render="@OnRender"
                        AllowPaging="true"
                        PagerAlwaysVisible="true"
                        PagerHorizontalAlign="Radzen.HorizontalAlign.Center"
                        AllowSorting="true"
                        AllowColumnResize="true"
                        AllowColumnReorder="true"
                        AllowFiltering="true"
                        FilterMode="FilterMode.Advanced"
                        ShowFilterRow="true"
                        FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                        LogicalFilterOperator="LogicalFilterOperator.And"
                        AllowGrouping="true"
                        AllGroupsExpanded="@_allGroupsExpanded"
                        AllGroupsExpandedChanged="@OnAllGroupsExpandedChanged"
                        GroupRowExpand="@OnGroupRowExpand"
                        GroupRowCollapse="@OnGroupRowCollapse"
                        Group="@OnGroupChanged"
                        ExpandGroupAriaLabel="Expandeaza grup"
                        RemoveGroupAriaLabel="Elimina gruparea"
                        PageSize="@_pageSize"
                        PageSizeOptions="@_pageSizeOptions"
                        ShowPagingSummary="true"
                        IsLoading="@_isLoading"
                        ExpandMode="Radzen.DataGridExpandMode.Single"
                        AllowRowSelectOnRowClick="false"
                        Settings="@_gridSettings"
                        SettingsChanged="@OnSettingsChanged"
                        Density="Density.Compact"
                        Style="min-height: 520px;">

            <GroupHeaderTemplate>
                @context.Data.Key: @context.Data.Count inregistrari
            </GroupHeaderTemplate>

            <Columns>
                <Radzen.Blazor.RadzenDataGridColumn TItem="PersonalMedicalListDto" Property="NumeComplet" Title="Nume complet" Width="180px" Filterable="true" Sortable="true" Groupable="true" />
                <Radzen.Blazor.RadzenDataGridColumn TItem="PersonalMedicalListDto" Property="Pozitie" Title="Pozitie" Width="140px" Filterable="true" Sortable="true" Groupable="true" />
                <Radzen.Blazor.RadzenDataGridColumn TItem="PersonalMedicalListDto" Property="Specializare" Title="Specializare" Width="140px" Filterable="true" Sortable="true" Groupable="true">
                    <Template Context="personal">@(personal.Specializare ?? "Nu este specificata")</Template>
                </Radzen.Blazor.RadzenDataGridColumn>
                <Radzen.Blazor.RadzenDataGridColumn TItem="PersonalMedicalListDto" Property="Departament" Title="Departament" Width="120px" Filterable="true" Sortable="true" Groupable="true">
                    <Template Context="personal">@(personal.Departament ?? "Nu este specificat")</Template>
                </Radzen.Blazor.RadzenDataGridColumn>
                <Radzen.Blazor.RadzenDataGridColumn TItem="PersonalMedicalListDto" Property="NumarLicenta" Title="Nr. Licenta" Width="110px" Filterable="true" Sortable="true" />
                <Radzen.Blazor.RadzenDataGridColumn TItem="PersonalMedicalListDto" Property="Telefon" Title="Telefon" Width="110px" Filterable="true" Sortable="true">
                    <Template Context="personal">@(personal.Telefon ?? "Nu este specificat")</Template>
                </Radzen.Blazor.RadzenDataGridColumn>
                <Radzen.Blazor.RadzenDataGridColumn TItem="PersonalMedicalListDto" Property="Email" Title="Email" Width="180px" Filterable="true" Sortable="true">
                    <Template Context="personal">@(personal.Email ?? "Nu este specificat")</Template>
                </Radzen.Blazor.RadzenDataGridColumn>
                <Radzen.Blazor.RadzenDataGridColumn TItem="PersonalMedicalListDto" Property="EsteActiv" Title="Status" Width="90px" Filterable="true" Sortable="true" Groupable="true">
                    <Template Context="personal">
                        <RadzenBadge Text="@(personal.EsteActiv ? "Activ" : "Inactiv")" 
                                     BadgeStyle="@(personal.EsteActiv ? Radzen.BadgeStyle.Success : Radzen.BadgeStyle.Secondary)" 
                                     Variant="Radzen.Variant.Filled"
                                     Class="status-badge" />
                    </Template>
                </Radzen.Blazor.RadzenDataGridColumn>
                <Radzen.Blazor.RadzenDataGridColumn TItem="PersonalMedicalListDto" Property="DataCreare" Title="Data crearii" Width="120px" Filterable="true" Sortable="true" FormatString="{0:dd.MM.yyyy}" />
                <Radzen.Blazor.RadzenDataGridColumn TItem="PersonalMedicalListDto" Title="Actiuni" Width="200px" Sortable="false" Filterable="false" Groupable="false">
                    <Template Context="personal">
                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="0.25rem">
                            <RadzenButton Icon="visibility" 
                                        ButtonStyle="ButtonStyle.Success" 
                                        Variant="Radzen.Variant.Outlined" 
                                        Size="ButtonSize.Small" 
                                        Title="Vizualizeaza" 
                                        Click="@(() => ViewPersonal(personal.PersonalID))" />
                            <RadzenButton Icon="edit" 
                                        ButtonStyle="ButtonStyle.Info" 
                                        Variant="Radzen.Variant.Outlined" 
                                        Size="ButtonSize.Small" 
                                        Title="Editeaza" 
                                        Click="@(() => EditPersonal(personal.PersonalID))" />
                            <RadzenButton Icon="delete" 
                                        ButtonStyle="ButtonStyle.Danger" 
                                        Variant="Radzen.Variant.Outlined" 
                                        Size="ButtonSize.Small" 
                                        Title="Sterge" 
                                        Click="@(async () => await DeletePersonal(personal.PersonalID, personal.NumeComplet))" />
                        </RadzenStack>
                    </Template>
                </Radzen.Blazor.RadzenDataGridColumn>
            </Columns>

            <!-- Master-Detail Template pentru fiecare rând -->
            <Template Context="personal">
                <RadzenCard Class="detail-card">
                    <RadzenStack Orientation="Radzen.Orientation.Vertical" Gap="0.75rem">
                        
                        <!-- Header Detail -->
                        <RadzenRow>
                            <RadzenColumn Size="12">
                                <RadzenText TextStyle="TextStyle.Body1" Class="detail-header-title">
                                    <RadzenIcon Icon="badge" Class="detail-header-icon" />
                                    Detalii Complete - @personal.NumeComplet
                                </RadzenText>
                            </RadzenColumn>
                        </RadzenRow>

                        <!-- Main Details Row -->
                        <RadzenRow Gap="1rem">
                            <!-- Personal Information -->
                            <RadzenColumn Size="12" SizeMD="6">
                                <RadzenCard Class="info-section-card">
                                    <RadzenText TextStyle="TextStyle.Body1" Class="info-section-title">
                                        <RadzenIcon Icon="person" Class="info-section-icon personal-icon" />
                                        Informatii Personale
                                    </RadzenText>
                                    <RadzenStack Orientation="Radzen.Orientation.Vertical" Gap="0.5rem">
                                        <RadzenRow>
                                            <RadzenColumn Size="5"><strong>Nume complet:</strong></RadzenColumn>
                                            <RadzenColumn Size="7">@personal.NumeComplet</RadzenColumn>
                                        </RadzenRow>
                                        <RadzenRow>
                                            <RadzenColumn Size="5"><strong>Pozitie:</strong></RadzenColumn>
                                            <RadzenColumn Size="7">
                                                <RadzenBadge Text="@personal.Pozitie" BadgeStyle="BadgeStyle.Primary" Variant="Radzen.Variant.Filled" />
                                            </RadzenColumn>
                                        </RadzenRow>
                                        <RadzenRow>
                                            <RadzenColumn Size="5"><strong>Specializare:</strong></RadzenColumn>
                                            <RadzenColumn Size="7">@(personal.Specializare ?? "Nu este specificata")</RadzenColumn>
                                        </RadzenRow>
                                        <RadzenRow>
                                            <RadzenColumn Size="5"><strong>Departament:</strong></RadzenColumn>
                                            <RadzenColumn Size="7">@(personal.Departament ?? "Nu este specificat")</RadzenColumn>
                                        </RadzenRow>
                                        <RadzenRow>
                                            <RadzenColumn Size="5"><strong>Nr. Licenta:</strong></RadzenColumn>
                                            <RadzenColumn Size="7">
                                                <RadzenBadge Text="@(personal.NumarLicenta ?? "N/A")" 
                                                           BadgeStyle="BadgeStyle.Secondary" 
                                                           Variant="Radzen.Variant.Outlined" />
                                            </RadzenColumn>
                                        </RadzenRow>
                                    </RadzenStack>
                                </RadzenCard>
                            </RadzenColumn>

                            <!-- Contact & Status Information -->
                            <RadzenColumn Size="12" SizeMD="6">
                                <RadzenCard Class="info-section-card">
                                    <RadzenText TextStyle="TextStyle.Body1" Class="info-section-title">
                                        <RadzenIcon Icon="contact_phone" Class="info-section-icon contact-icon" />
                                        Contact & Status
                                    </RadzenText>
                                    <RadzenStack Orientation="Radzen.Orientation.Vertical" Gap="0.5rem">
                                        <RadzenRow>
                                            <RadzenColumn Size="4"><strong>Telefon:</strong></RadzenColumn>
                                            <RadzenColumn Size="8">
                                                @if (!string.IsNullOrEmpty(personal.Telefon))
                                                {
                                                    <RadzenLink Text="@personal.Telefon" Path="@($"tel:{personal.Telefon}")" />
                                                }
                                                else
                                                {
                                                    <span class="text-muted">Nu este specificat</span>
                                                }
                                            </RadzenColumn>
                                        </RadzenRow>
                                        <RadzenRow>
                                            <RadzenColumn Size="4"><strong>Email:</strong></RadzenColumn>
                                            <RadzenColumn Size="8">
                                                @if (!string.IsNullOrEmpty(personal.Email))
                                                {
                                                    <RadzenLink Text="@personal.Email" Path="@($"mailto:{personal.Email}")" />
                                                }
                                                else
                                                {
                                                    <span class="text-muted">Nu este specificat</span>
                                                }
                                            </RadzenColumn>
                                        </RadzenRow>
                                        <RadzenRow>
                                            <RadzenColumn Size="4"><strong>Status:</strong></RadzenColumn>
                                            <RadzenColumn Size="8">
                                                <RadzenBadge Text="@(personal.EsteActiv ? "ACTIV" : "INACTIV")" 
                                                           BadgeStyle="@(personal.EsteActiv ? Radzen.BadgeStyle.Success : Radzen.BadgeStyle.Danger)" 
                                                           Variant="Radzen.Variant.Filled"
                                                           Class="status-badge-large" />
                                            </RadzenColumn>
                                        </RadzenRow>
                                        <RadzenRow>
                                            <RadzenColumn Size="4"><strong>Data crearii:</strong></RadzenColumn>
                                            <RadzenColumn Size="8">
                                                <RadzenText TextStyle="TextStyle.Caption">
                                                    @personal.DataCreare.ToString("dd MMM yyyy, HH:mm")
                                                </RadzenText>
                                            </RadzenColumn>
                                        </RadzenRow>
                                    </RadzenStack>
                                </RadzenCard>
                            </RadzenColumn>
                        </RadzenRow>

                        <!-- Action Buttons -->
                        <RadzenRow>
                            <RadzenColumn Size="12" Class="text-end">
                                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="0.5rem">
                                    <RadzenButton Text="Vizualizeaza Complet" 
                                                Icon="launch" 
                                                ButtonStyle="ButtonStyle.Info"
                                                Size="ButtonSize.Small"
                                                Click="@(() => ViewPersonal(personal.PersonalID))" />
                                    <RadzenButton Text="Editeaza" 
                                                Icon="edit" 
                                                ButtonStyle="ButtonStyle.Secondary"
                                                Size="ButtonSize.Small"
                                                Click="@(() => EditPersonal(personal.PersonalID))" />
                                    <RadzenButton Text="Sterge" 
                                                Icon="delete" 
                                                ButtonStyle="ButtonStyle.Danger"
                                                Size="ButtonSize.Small"
                                                Click="@(async () => await DeletePersonal(personal.PersonalID, personal.NumeComplet))" />
                                </RadzenStack>
                            </RadzenColumn>
                        </RadzenRow>

                    </RadzenStack>
                </RadzenCard>
            </Template>
        </RadzenDataGrid>
    </RadzenCard>
</RadzenStack>

@code {
}