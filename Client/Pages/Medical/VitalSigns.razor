@page "/medical/semne-vitale"
@using global::Shared.DTOs.Medical
@using global::Shared.Models.Medical
@using global::Shared.Validators.Medical
@using global::FluentValidation
@using MudBlazor
@inject HttpClient Http
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<PageTitle>Semne Vitale - ValyanMed</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="pa-4">
    <!-- Header -->
    <MudPaper Class="pa-4 mb-4" Elevation="2">
        <MudGrid AlignItems="Center">
            <MudItem xs="12" md="8">
                <MudText Typo="Typo.h4" Color="Color.Primary">
                    <MudIcon Icon="Icons.Material.Filled.MonitorHeart" Class="mr-3" />
                    Înregistrare Semne Vitale
                </MudText>
                <MudText Typo="Typo.body1" Color="Color.Secondary">
                    Monitorizarea ?i înregistrarea parametrilor vitali ai pacien?ilor
                </MudText>
            </MudItem>
            <MudItem xs="12" md="4" Class="d-flex justify-end">
                <MudButton Variant="Variant.Outlined" 
                          Color="Color.Secondary" 
                          StartIcon="Icons.Material.Filled.ArrowBack"
                          OnClick="@(() => Navigation.NavigateTo("/medical/dashboard"))">
                    Înapoi la Dashboard
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <!-- Quick Patient Search -->
    <MudPaper Class="pa-4 mb-4" Elevation="1">
        <MudGrid AlignItems="Center">
            <MudItem xs="12" md="8">
                <MudAutocomplete T="PacientListDto"
                               @bind-Value="_selectedPatient"
                               SearchFunc="SearchPatients"
                               ToStringFunc="p => p?.NumeComplet ?? string.Empty"
                               Label="C?utare pacient"
                               Placeholder="Introduce?i numele pacientului sau CNP"
                               Variant="Variant.Outlined"
                               Immediate="true"
                               ResetValueOnEmptyText="true"
                               Adornment="Adornment.Start"
                               AdornmentIcon="Icons.Material.Filled.Search">
                    <ItemTemplate Context="patient">
                        <div>
                            <MudText Typo="Typo.body1">@patient.NumeComplet</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                @if (!string.IsNullOrEmpty(patient.CNP))
                                {
                                    <span>CNP: @patient.CNP</span>
                                }
                                @if (!string.IsNullOrEmpty(patient.CNP) && patient.Varsta > 0)
                                {
                                    <span> | </span>
                                }
                                @if (patient.Varsta > 0)
                                {
                                    <span>Vârsta: @patient.Varsta ani</span>
                                }
                            </MudText>
                        </div>
                    </ItemTemplate>
                </MudAutocomplete>
            </MudItem>
            <MudItem xs="12" md="4">
                <MudButton Variant="Variant.Filled"
                          Color="Color.Primary"
                          StartIcon="Icons.Material.Filled.Add"
                          OnClick="StartNewVitalSigns"
                          Disabled="_selectedPatient == null"
                          FullWidth="true">
                    Semne vitale noi
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (_selectedPatient != null)
    {
        <!-- Patient Info Card -->
        <MudPaper Class="pa-4 mb-4" Elevation="1">
            <MudGrid AlignItems="Center">
                <MudItem xs="12" md="8">
                    <MudText Typo="Typo.h6">@_selectedPatient.NumeComplet</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        @if (!string.IsNullOrEmpty(_selectedPatient.CNP))
                        {
                            <span>CNP: @_selectedPatient.CNP | </span>
                        }
                        <span>Vârsta: @_selectedPatient.Varsta ani | Gen: @_selectedPatient.Gen</span>
                    </MudText>
                </MudItem>
                <MudItem xs="12" md="4" Class="d-flex justify-end">
                    <MudButton Variant="Variant.Text"
                              Color="Color.Primary"
                              StartIcon="Icons.Material.Filled.History"
                              OnClick="ViewVitalSignsHistory">
                        Istoric semne vitale
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudPaper>

        <!-- Vital Signs Form -->
        @if (_showVitalSignsForm)
        {
            <MudForm @ref="_form" Model="_vitalSignsRequest" Validation="_validator">
                <MudPaper Class="pa-4 mb-4" Elevation="2">
                    <MudText Typo="Typo.h6" Class="mb-4">
                        <MudIcon Icon="Icons.Material.Filled.MonitorHeart" Class="mr-2" />
                        Înregistrare semne vitale - @DateTime.Now.ToString("dd.MM.yyyy HH:mm")
                    </MudText>

                    <MudGrid>
                        <!-- Tensiune arterial? -->
                        <MudItem xs="12" md="6">
                            <MudPaper Class="pa-3" Elevation="1">
                                <MudText Typo="Typo.subtitle1" Class="mb-3">
                                    <MudIcon Icon="Icons.Material.Filled.MonitorHeart" Size="Size.Small" Class="mr-1" />
                                    Tensiune arterial?
                                </MudText>
                                <MudGrid>
                                    <MudItem xs="6">
                                        <MudNumericField T="int?" @bind-Value="_vitalSignsRequest.TensiuneArterialaMax"
                                                        Label="Sistolic? (mmHg)"
                                                        Variant="Variant.Outlined"
                                                        Min="60" Max="250"
                                                        For="@(() => _vitalSignsRequest.TensiuneArterialaMax)" />
                                    </MudItem>
                                    <MudItem xs="6">
                                        <MudNumericField T="int?" @bind-Value="_vitalSignsRequest.TensiuneArterialaMin"
                                                        Label="Diastolic? (mmHg)"
                                                        Variant="Variant.Outlined"
                                                        Min="40" Max="150"
                                                        For="@(() => _vitalSignsRequest.TensiuneArterialaMin)" />
                                    </MudItem>
                                </MudGrid>
                                @if (_vitalSignsRequest.TensiuneArterialaMax.HasValue && _vitalSignsRequest.TensiuneArterialaMin.HasValue)
                                {
                                    <MudAlert Severity="@GetBloodPressureSeverity(_vitalSignsRequest.TensiuneArterialaMax.Value, _vitalSignsRequest.TensiuneArterialaMin.Value)" 
                                             Class="mt-2" Dense="true">
                                        @GetBloodPressureInterpretation(_vitalSignsRequest.TensiuneArterialaMax.Value, _vitalSignsRequest.TensiuneArterialaMin.Value)
                                    </MudAlert>
                                }
                            </MudPaper>
                        </MudItem>

                        <!-- Puls ?i temperatura -->
                        <MudItem xs="12" md="6">
                            <MudPaper Class="pa-3" Elevation="1">
                                <MudText Typo="Typo.subtitle1" Class="mb-3">
                                    <MudIcon Icon="Icons.Material.Filled.Favorite" Size="Size.Small" Class="mr-1" />
                                    Puls ?i temperatur?
                                </MudText>
                                <MudGrid>
                                    <MudItem xs="6">
                                        <MudNumericField T="int?" @bind-Value="_vitalSignsRequest.FrecariaCardiaca"
                                                        Label="Puls (bpm)"
                                                        Variant="Variant.Outlined"
                                                        Min="30" Max="200"
                                                        For="@(() => _vitalSignsRequest.FrecariaCardiaca)" />
                                    </MudItem>
                                    <MudItem xs="6">
                                        <MudNumericField T="decimal?" @bind-Value="_vitalSignsRequest.Temperatura"
                                                        Label="Temperatur? (°C)"
                                                        Variant="Variant.Outlined"
                                                        Min="30.0m" Max="45.0m"
                                                        Step="0.1m"
                                                        For="@(() => _vitalSignsRequest.Temperatura)" />
                                    </MudItem>
                                </MudGrid>
                                @if (_vitalSignsRequest.Temperatura.HasValue)
                                {
                                    <MudAlert Severity="@GetTemperatureSeverity(_vitalSignsRequest.Temperatura.Value)" 
                                             Class="mt-2" Dense="true">
                                        @GetTemperatureInterpretation(_vitalSignsRequest.Temperatura.Value)
                                    </MudAlert>
                                }
                            </MudPaper>
                        </MudItem>

                        <!-- Date antropometrice -->
                        <MudItem xs="12" md="6">
                            <MudPaper Class="pa-3" Elevation="1">
                                <MudText Typo="Typo.subtitle1" Class="mb-3">
                                    <MudIcon Icon="Icons.Material.Filled.Scale" Size="Size.Small" Class="mr-1" />
                                    Date antropometrice
                                </MudText>
                                <MudGrid>
                                    <MudItem xs="6">
                                        <MudNumericField T="decimal?" @bind-Value="_vitalSignsRequest.Greutate"
                                                        Label="Greutate (kg)"
                                                        Variant="Variant.Outlined"
                                                        Min="10.0m" Max="300.0m"
                                                        Step="0.1m"
                                                        For="@(() => _vitalSignsRequest.Greutate)" />
                                    </MudItem>
                                    <MudItem xs="6">
                                        <MudNumericField T="int?" @bind-Value="_vitalSignsRequest.Inaltime"
                                                        Label="În?l?ime (cm)"
                                                        Variant="Variant.Outlined"
                                                        Min="50" Max="250"
                                                        For="@(() => _vitalSignsRequest.Inaltime)" />
                                    </MudItem>
                                </MudGrid>
                                @if (_vitalSignsRequest.Greutate.HasValue && _vitalSignsRequest.Inaltime.HasValue)
                                {
                                    var bmi = CalculateBMI(_vitalSignsRequest.Greutate.Value, _vitalSignsRequest.Inaltime.Value);
                                    <MudAlert Severity="@GetBMISeverity(bmi)" Class="mt-2" Dense="true">
                                        BMI: @bmi.ToString("F1") - @GetBMIInterpretation(bmi)
                                    </MudAlert>
                                }
                            </MudPaper>
                        </MudItem>

                        <!-- Respira?ie ?i satura?ie -->
                        <MudItem xs="12" md="6">
                            <MudPaper Class="pa-3" Elevation="1">
                                <MudText Typo="Typo.subtitle1" Class="mb-3">
                                    <MudIcon Icon="Icons.Material.Filled.Air" Size="Size.Small" Class="mr-1" />
                                    Respira?ie ?i satura?ie
                                </MudText>
                                <MudGrid>
                                    <MudItem xs="6">
                                        <MudNumericField T="int?" @bind-Value="_vitalSignsRequest.FrecariaRespiratorie"
                                                        Label="Frecven?a respiratorie (/min)"
                                                        Variant="Variant.Outlined"
                                                        Min="5" Max="60"
                                                        For="@(() => _vitalSignsRequest.FrecariaRespiratorie)" />
                                    </MudItem>
                                    <MudItem xs="6">
                                        <MudNumericField T="decimal?" @bind-Value="_vitalSignsRequest.SaturatieOxigen"
                                                        Label="Satura?ie O? (%)"
                                                        Variant="Variant.Outlined"
                                                        Min="70.0m" Max="100.0m"
                                                        Step="0.1m"
                                                        For="@(() => _vitalSignsRequest.SaturatieOxigen)" />
                                    </MudItem>
                                </MudGrid>
                                @if (_vitalSignsRequest.SaturatieOxigen.HasValue)
                                {
                                    <MudAlert Severity="@GetOxygenSaturationSeverity(_vitalSignsRequest.SaturatieOxigen.Value)" 
                                             Class="mt-2" Dense="true">
                                        @GetOxygenSaturationInterpretation(_vitalSignsRequest.SaturatieOxigen.Value)
                                    </MudAlert>
                                }
                            </MudPaper>
                        </MudItem>
                    </MudGrid>

                    <!-- Action Buttons -->
                    <MudDivider Class="my-4" />
                    <MudGrid AlignItems="Center">
                        <MudItem xs="12" md="6">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                <MudIcon Icon="Icons.Material.Filled.Info" Size="Size.Small" Class="mr-1" />
                                Toate valorile sunt op?ionale, dar se recomand? completarea celor relevante
                            </MudText>
                        </MudItem>
                        <MudItem xs="12" md="6" Class="d-flex justify-end">
                            <MudButtonGroup Variant="Variant.Filled">
                                <MudButton Color="Color.Secondary"
                                          StartIcon="Icons.Material.Filled.Cancel"
                                          OnClick="CancelVitalSigns"
                                          Disabled="_isProcessing">
                                    Anuleaz?
                                </MudButton>
                                <MudButton Color="Color.Primary"
                                          StartIcon="@(_isProcessing ? null : Icons.Material.Filled.Save)"
                                          OnClick="SaveVitalSigns"
                                          Disabled="_isProcessing">
                                    @if (_isProcessing)
                                    {
                                        <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                                        <span class="ml-2">Se salveaz?...</span>
                                    }
                                    else
                                    {
                                        <span>Salveaz? semnele vitale</span>
                                    }
                                </MudButton>
                            </MudButtonGroup>
                        </MudItem>
                    </MudGrid>
                </MudPaper>
            </MudForm>
        }

        <!-- Recent Vital Signs History -->
        @if (_recentVitalSigns?.Any() == true)
        {
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.h6" Class="mb-4">
                    <MudIcon Icon="Icons.Material.Filled.History" Class="mr-2" />
                    Istoric recent semne vitale
                </MudText>

                <MudTable Items="_recentVitalSigns" Hover="true" Dense="true">
                    <HeaderContent>
                        <MudTh>Data/Ora</MudTh>
                        <MudTh>Tensiune arterial?</MudTh>
                        <MudTh>Puls</MudTh>
                        <MudTh>Temperatur?</MudTh>
                        <MudTh>Greutate</MudTh>
                        <MudTh>Satura?ie O?</MudTh>
                        <MudTh>M?surat de</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd>
                            <MudText Typo="Typo.body2">@context.DataMasurare.ToString("dd.MM.yyyy")</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@context.DataMasurare.ToString("HH:mm")</MudText>
                        </MudTd>
                        <MudTd>
                            @if (!string.IsNullOrEmpty(context.TensiuneArteriala))
                            {
                                <MudText Typo="Typo.body2">@context.TensiuneArteriala</MudText>
                            }
                            else
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary">-</MudText>
                            }
                        </MudTd>
                        <MudTd>
                            @if (context.FrecariaCardiaca.HasValue)
                            {
                                <MudText Typo="Typo.body2">@context.FrecariaCardiaca bpm</MudText>
                            }
                            else
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary">-</MudText>
                            }
                        </MudTd>
                        <MudTd>
                            @if (context.Temperatura.HasValue)
                            {
                                <MudText Typo="Typo.body2">@context.Temperatura.Value.ToString("F1")°C</MudText>
                            }
                            else
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary">-</MudText>
                            }
                        </MudTd>
                        <MudTd>
                            @if (context.Greutate.HasValue)
                            {
                                <MudText Typo="Typo.body2">@context.Greutate.Value.ToString("F1") kg</MudText>
                                @if (context.BMI.HasValue)
                                {
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">BMI: @context.BMI.Value.ToString("F1")</MudText>
                                }
                            }
                            else
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary">-</MudText>
                            }
                        </MudTd>
                        <MudTd>
                            @if (context.SaturatieOxigen.HasValue)
                            {
                                <MudText Typo="Typo.body2">@context.SaturatieOxigen.Value.ToString("F1")%</MudText>
                            }
                            else
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary">-</MudText>
                            }
                        </MudTd>
                        <MudTd>
                            <MudText Typo="Typo.caption">Personal medical</MudText>
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </MudPaper>
        }
    }
</MudContainer>