@page "/medical/personal/nou"
@page "/medical/personal/editare/{PersonalId:guid}"
@using global::Shared.DTOs.Medical
@using global::Shared.Enums.Medical
@using global::Shared.Common
@using Radzen
@using Radzen.Blazor
@using Client.Services.Medical
@using FluentValidation

<PageTitle>@(_isEditMode ? "Modifica Personal Medical" : "Adauga Personal Medical") - ValyanMed</PageTitle>

<RadzenRow Class="rz-p-4">
    <RadzenColumn Size="12">
        
        <!-- Header Card - FOLOSESTE CLASELE GLOBALE -->
        <RadzenCard Class="page-header-card rz-mb-4">
            <RadzenRow JustifyContent="Radzen.JustifyContent.SpaceBetween" AlignItems="Radzen.AlignItems.Center">
                <RadzenColumn Size="12">
                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="1rem">
                        <RadzenIcon Icon="@(_isEditMode ? "edit" : "person_add")" Class="page-header-icon" />
                        <RadzenText TextStyle="TextStyle.H4" Class="page-header-title">
                            @(_isEditMode ? "Modifica Personal Medical" : "Adauga Personal Medical Nou")
                        </RadzenText>
                    </RadzenStack>
                </RadzenColumn>
            </RadzenRow>
        </RadzenCard>

        <!-- Loading Indicator -->
        @if (_isLoading)
        {
            <RadzenCard>
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="Radzen.JustifyContent.Center" AlignItems="Radzen.AlignItems.Center" Gap="1rem" Style="padding: 2rem;">
                    <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Medium" />
                    <RadzenStack Orientation="Radzen.Orientation.Vertical" AlignItems="Radzen.AlignItems.Start" Gap="0.5rem">
                        <RadzenText TextStyle="TextStyle.Body1">
                            @(_isEditMode ? "Se incarca datele personalului..." : "Se initializeaza formularul...")
                        </RadzenText>
                        <RadzenText TextStyle="TextStyle.Body2" Style="color: #6c757d;">
                            Va rugam sa asteptati...
                        </RadzenText>
                    </RadzenStack>
                </RadzenStack>
            </RadzenCard>
        }
        else if (_isProcessing)
        {
            <!-- Processing Indicator -->
            <RadzenCard Style="border-left: 4px solid #0d6efd;">
                <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="Radzen.JustifyContent.Center" AlignItems="Radzen.AlignItems.Center" Gap="1rem" Style="padding: 1.5rem;">
                    <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Small" />
                    <RadzenStack Orientation="Radzen.Orientation.Vertical" AlignItems="Radzen.AlignItems.Start" Gap="0.5rem">
                        <RadzenText TextStyle="TextStyle.Body1" Style="color: #0d6efd;">
                            @(_isEditMode ? "Se actualizeaza..." : "Se salveaza...")
                        </RadzenText>
                        <RadzenText TextStyle="TextStyle.Body2" Style="color: #6c757d;">
                            Procesarea datelor in curs...
                        </RadzenText>
                    </RadzenStack>
                </RadzenStack>
            </RadzenCard>
        }
        else
        {
            <RadzenRow Gap="2rem">
                <!-- Form Section -->
                <RadzenColumn Size="12" SizeLG="8">
                    <!-- Form Card -->
                    <RadzenCard Style="max-width: 900px;">
                        <RadzenTemplateForm TItem="CreatePersonalMedicalRequest" Data="@_model" Submit="@OnSubmitAsync">
                            <DataAnnotationsValidator />
                            
                            <RadzenStack Gap="2rem">
                                
                                <!-- Informatii Personale -->
                                <RadzenFieldset Text="Informatii Personale">
                                    <RadzenRow Gap="1rem" RowGap="1.5rem">
                                        <!-- Nume -->
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenText TextStyle="TextStyle.Body2" Class="rz-mb-2">
                                                Nume <span style="color: #dc3545; font-weight: bold;">*</span>
                                            </RadzenText>
                                            <RadzenTextBox @bind-Value="_model.Nume" 
                                                          Name="Nume"
                                                          Placeholder="Introduceti numele..." 
                                                          MaxLength="100"
                                                          Style="width: 100%;"
                                                          Variant="Radzen.Variant.Outlined"
                                                          Change="@(() => OnFieldChanged(nameof(_model.Nume)))"
                                                          @oninput="@(() => OnFieldChanged(nameof(_model.Nume)))" />
                                            <RadzenRequiredValidator Component="Nume" Text="Numele este obligatoriu" />
                                        </RadzenColumn>
                                        
                                        <!-- Prenume -->
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenText TextStyle="TextStyle.Body2" Class="rz-mb-2">
                                                Prenume <span style="color: #dc3545; font-weight: bold;">*</span>
                                            </RadzenText>
                                            <RadzenTextBox @bind-Value="_model.Prenume" 
                                                          Name="Prenume"
                                                          Placeholder="Introduceti prenumele..." 
                                                          MaxLength="100"
                                                          Style="width: 100%;"
                                                          Variant="Radzen.Variant.Outlined"
                                                          Change="@(() => OnFieldChanged(nameof(_model.Prenume)))"
                                                          @oninput="@(() => OnFieldChanged(nameof(_model.Prenume)))" />
                                            <RadzenRequiredValidator Component="Prenume" Text="Prenumele este obligatoriu" />
                                        </RadzenColumn>
                                        
                                        <!-- Pozitie -->
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenText TextStyle="TextStyle.Body2" Class="rz-mb-2">
                                                Pozitie <span style="color: #dc3545; font-weight: bold;">*</span>
                                            </RadzenText>
                                            <RadzenDropDown @bind-Value="_model.Pozitie" 
                                                           Name="Pozitie"
                                                           Data="@_pozitiiOptions" 
                                                           TextProperty="Text" 
                                                           ValueProperty="Value"
                                                           Placeholder="Selecteaza pozitia..." 
                                                           AllowClear="false"
                                                           AllowFiltering="true"
                                                           Style="width: 100%;"
                                                           Variant="Radzen.Variant.Outlined"
                                                           Change="@OnPozitieChanged" />
                                            <RadzenRequiredValidator Component="Pozitie" Text="Pozitia este obligatorie" />
                                        </RadzenColumn>

                                        <!-- Status -->
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenText TextStyle="TextStyle.Body2" Class="rz-mb-2">Status</RadzenText>
                                            <RadzenStack Orientation="Radzen.Orientation.Horizontal" AlignItems="Radzen.AlignItems.Center" Gap="0.75rem" 
                                                       Style="height: 40px; border: 1px solid #dee2e6; border-radius: 4px; padding: 0 12px; background: white;">
                                                <RadzenCheckBox @bind-Value="_model.EsteActiv" 
                                                               Name="EsteActiv" 
                                                               Change="@(async (bool value) => await OnFieldChanged(nameof(_model.EsteActiv)))" />
                                                <RadzenLabel Text="Personal activ in sistem" Component="EsteActiv" />
                                            </RadzenStack>
                                        </RadzenColumn>
                                    </RadzenRow>
                                </RadzenFieldset>

                                <!-- Informatii Profesionale - ACTUALIZAT CU IERARHIE -->
                                <RadzenFieldset Text="Informatii Profesionale">
                                    <RadzenRow Gap="1rem" RowGap="1.5rem">
                                        <!-- Categorie (fostul Departament) -->
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenText TextStyle="TextStyle.Body2" Class="rz-mb-2">
                                                Categorie <span style="color: #dc3545; font-weight: bold;">*</span>
                                            </RadzenText>
                                            <RadzenDropDown @bind-Value="_model.CategorieID" 
                                                           Name="CategorieID"
                                                           Data="@_categoriiOptions" 
                                                           TextProperty="Text" 
                                                           ValueProperty="Value"
                                                           Placeholder="Selecteaza categoria..." 
                                                           AllowClear="true"
                                                           AllowFiltering="true"
                                                           Style="width: 100%;"
                                                           Variant="Radzen.Variant.Outlined"
                                                           Change="@OnCategorieChanged" />
                                            <RadzenRequiredValidator Component="CategorieID" Text="Categoria este obligatorie" />
                                        </RadzenColumn>

                                        <!-- Specializare (dropdown dependent de Categorie) -->
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenText TextStyle="TextStyle.Body2" Class="rz-mb-2">
                                                Specializare <span style="color: #dc3545; font-weight: bold;">*</span>
                                            </RadzenText>
                                            <RadzenDropDown @bind-Value="_model.SpecializareID" 
                                                           Name="SpecializareID"
                                                           Data="@_specializariOptions" 
                                                           TextProperty="Text" 
                                                           ValueProperty="Value"
                                                           Placeholder="Selecteaza specializarea..." 
                                                           AllowClear="true"
                                                           AllowFiltering="true"
                                                           Style="width: 100%;"
                                                           Variant="Radzen.Variant.Outlined"
                                                           Disabled="@(!_model.CategorieID.HasValue || !_specializariOptions.Any())"
                                                           Change="@OnSpecializareChanged" />
                                            <RadzenRequiredValidator Component="SpecializareID" Text="Specializarea este obligatorie" />
                                            @if (_showSpecializareWarning)
                                            {
                                                <div class="business-warning">
                                                    <RadzenIcon Icon="info" />
                                                    Specializarea este recomandata pentru aceasta pozitie
                                                </div>
                                            }
                                            @if (_model.CategorieID.HasValue && !_specializariOptions.Any())
                                            {
                                                <div class="info-message">
                                                    <RadzenIcon Icon="info" />
                                                    Nu exista specializari disponibile pentru categoria selectata
                                                </div>
                                            }
                                        </RadzenColumn>

                                        <!-- Subspecializare (dropdown dependent de Specializare) -->
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenText TextStyle="TextStyle.Body2" Class="rz-mb-2">Subspecializare</RadzenText>
                                            <RadzenDropDown @bind-Value="_model.SubspecializareID" 
                                                           Name="SubspecializareID"
                                                           Data="@_subspecializariOptions" 
                                                           TextProperty="Text" 
                                                           ValueProperty="Value"
                                                           Placeholder="Selecteaza subspecializarea..." 
                                                           AllowClear="true"
                                                           AllowFiltering="true"
                                                           Style="width: 100%;"
                                                           Variant="Radzen.Variant.Outlined"
                                                           Disabled="@(!_model.SpecializareID.HasValue || !_subspecializariOptions.Any())"
                                                           Change="@OnSubspecializareChanged" />
                                            @if (_model.SpecializareID.HasValue && !_subspecializariOptions.Any())
                                            {
                                                <div class="info-message">
                                                    <RadzenIcon Icon="info" />
                                                    Nu exista subspecializari disponibile pentru specializarea selectata
                                                </div>
                                            }
                                        </RadzenColumn>

                                        <!-- Numar Licenta -->
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenText TextStyle="TextStyle.Body2" Class="rz-mb-2">
                                                Numar Licenta <span style="color: #dc3545; font-weight: bold;">*</span>
                                            </RadzenText>
                                            <RadzenTextBox @bind-Value="_model.NumarLicenta" 
                                                          Name="NumarLicenta"
                                                          Placeholder="Introduceti numarul de licenta..." 
                                                          MaxLength="50"
                                                          Style="width: 100%;"
                                                          Variant="Radzen.Variant.Outlined"
                                                          Change="@(() => OnFieldChanged(nameof(_model.NumarLicenta)))"
                                                          @oninput="@(() => OnFieldChanged(nameof(_model.NumarLicenta)))" />
                                            <RadzenRequiredValidator Component="NumarLicenta" Text="Numarul de licenta este obligatoriu" />
                                            @if (_showLicentaWarning)
                                            {
                                                <div class="business-warning">
                                                    <RadzenIcon Icon="info" />
                                                    Numarul de licenta este obligatoriu pentru aceasta pozitie
                                                </div>
                                            }
                                        </RadzenColumn>
                                    </RadzenRow>
                                </RadzenFieldset>

                                <!-- Informatii de Contact -->
                                <RadzenFieldset Text="Informatii de Contact">
                                    <RadzenRow Gap="1rem" RowGap="1.5rem">
                                        <!-- Telefon -->
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenText TextStyle="TextStyle.Body2" Class="rz-mb-2">
                                                Telefon <span style="color: #dc3545; font-weight: bold;">*</span>
                                            </RadzenText>
                                            <RadzenTextBox @bind-Value="_model.Telefon" 
                                                          Name="Telefon"
                                                          Placeholder="Ex: 0721123456" 
                                                          MaxLength="20"
                                                          Style="width: 100%;"
                                                          Variant="Radzen.Variant.Outlined"
                                                          Change="@(() => OnFieldChanged(nameof(_model.Telefon)))"
                                                          @oninput="@(() => OnFieldChanged(nameof(_model.Telefon)))" />
                                            <RadzenRequiredValidator Component="Telefon" Text="Telefonul este obligatoriu" />
                                        </RadzenColumn>

                                        <!-- Email -->
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenText TextStyle="TextStyle.Body2" Class="rz-mb-2">
                                                Email <span style="color: #dc3545; font-weight: bold;">*</span>
                                            </RadzenText>
                                            <RadzenTextBox @bind-Value="_model.Email" 
                                                          Name="Email"
                                                          Placeholder="Ex: nume@valyanmed.ro" 
                                                          MaxLength="100"
                                                          Style="width: 100%;"
                                                          Variant="Radzen.Variant.Outlined"
                                                          Change="@(() => OnFieldChanged(nameof(_model.Email)))"
                                                          @oninput="@(() => OnFieldChanged(nameof(_model.Email)))" />
                                            <RadzenRequiredValidator Component="Email" Text="Email-ul este obligatoriu" />
                                            <RadzenEmailValidator Component="Email" Text="Formatul email-ului nu este valid" />
                                        </RadzenColumn>
                                    </RadzenRow>
                                </RadzenFieldset>

                                <!-- Action Buttons - UN SINGUR BUTON INAPOI IN STANGA JOS -->
                                <RadzenCard Variant="Radzen.Variant.Outlined" Class="rz-background-color-base-100" Style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 2px solid #dee2e6;">
                                    <RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="Radzen.JustifyContent.SpaceBetween" Gap="1rem">
                                        
                                        <!-- BUTON INAPOI PRINCIPAL - DOAR ACESTA RAMANE (STANGA JOS) -->
                                        <RadzenButton Text="Inapoi la lista" 
                                                     Icon="arrow_back" 
                                                     ButtonStyle="ButtonStyle.Info" 
                                                     Variant="Radzen.Variant.Filled"
                                                     Size="ButtonSize.Large"
                                                     Style="font-weight: 600; padding: 12px 20px; box-shadow: 0 4px 8px rgba(23, 162, 184, 0.3);"
                                                     Click="@BackToList"
                                                     Disabled="@_isProcessing" />
                                        
                                        <RadzenStack Orientation="Radzen.Orientation.Horizontal" Gap="1rem">
                                            <RadzenButton Text="Anuleaza" 
                                                         Icon="cancel" 
                                                         ButtonStyle="ButtonStyle.Danger" 
                                                         Variant="Radzen.Variant.Outlined"
                                                         Size="ButtonSize.Large"
                                                         Style="font-weight: 600; padding: 12px 20px;"
                                                         Click="@BackToList"
                                                         Disabled="@_isProcessing" />
                                                         
                                            <RadzenButton ButtonType="Radzen.ButtonType.Submit" 
                                                         Text="@GetSaveButtonText()" 
                                                         Icon="@GetSaveButtonIcon()" 
                                                         ButtonStyle="ButtonStyle.Success" 
                                                         Variant="Radzen.Variant.Filled"
                                                         Size="ButtonSize.Large"
                                                         Disabled="@_isProcessing"
                                                         IsBusy="@_isProcessing" 
                                                         Style="font-weight: bold; padding: 12px 24px; box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3); text-transform: uppercase;" />
                                        </RadzenStack>
                                    </RadzenStack>
                                </RadzenCard>
                            </RadzenStack>
                        </RadzenTemplateForm>
                    </RadzenCard>
                </RadzenColumn>

                <!-- Grid Preview Section -->
                <RadzenColumn Size="12" SizeLG="4">
                    <RadzenCard>
                        <RadzenStack Gap="1rem">
                            <RadzenText TextStyle="TextStyle.H6" Class="rz-m-0">
                                <RadzenIcon Icon="grid_view" Class="me-2" />
                                Preview Personal Medical
                            </RadzenText>
                            
                            @if (_isEditMode || (!string.IsNullOrEmpty(_model.Nume) || !string.IsNullOrEmpty(_model.Prenume)))
                            {
                                <!-- Grid cu preview-ul datelor folosind Radzen Grid -->
                                <RadzenGrid TItem="PersonalMedicalPreview" 
                                           Data="@_previewData" 
                                           AllowPaging="false"
                                           AllowSorting="false"
                                           AllowFiltering="false"
                                           ShowPagingSummary="false"
                                           Density="Density.Compact"
                                           Style="border: 1px solid var(--rz-border-color); height: 300px;">
                                    <Columns>
                                        <RadzenGridColumn TItem="PersonalMedicalPreview" Property="Nume" Title="Nume" Width="100px" />
                                        <RadzenGridColumn TItem="PersonalMedicalPreview" Property="Prenume" Title="Prenume" Width="100px" />
                                        <RadzenGridColumn TItem="PersonalMedicalPreview" Property="Pozitie" Title="Pozitie" Width="120px" />
                                        <RadzenGridColumn TItem="PersonalMedicalPreview" Property="Specializare" Title="Specializare" Width="120px" />
                                        <RadzenGridColumn TItem="PersonalMedicalPreview" Property="Categorie" Title="Categorie" Width="120px" />
                                        <RadzenGridColumn TItem="PersonalMedicalPreview" Property="Status" Title="Status" Width="80px" />
                                    </Columns>
                                </RadzenGrid>

                                @if (_previewData.Any())
                                {
                                    var personal = _previewData.First();
                                    if (!string.IsNullOrEmpty(personal.CategorieNume) || !string.IsNullOrEmpty(personal.SpecializareNume) || !string.IsNullOrEmpty(personal.SubspecializareNume))
                                    {
                                        <!-- Calea ierarhica completa -->
                                        <RadzenAlert AlertStyle="AlertStyle.Info" ShowIcon="true" AllowClose="false">
                                            <RadzenText TextStyle="TextStyle.Body2">
                                                <strong>Calea ierarhica:</strong><br />
                                                @{
                                                    var parts = new List<string>();
                                                    if (!string.IsNullOrEmpty(personal.CategorieNume)) parts.Add(personal.CategorieNume);
                                                    if (!string.IsNullOrEmpty(personal.SpecializareNume)) parts.Add(personal.SpecializareNume);
                                                    if (!string.IsNullOrEmpty(personal.SubspecializareNume)) parts.Add(personal.SubspecializareNume);
                                                }
                                                @string.Join(" > ", parts)
                                            </RadzenText>
                                        </RadzenAlert>
                                    }
                                }
                            }
                            else
                            {
                                <RadzenAlert AlertStyle="AlertStyle.Info" ShowIcon="true" AllowClose="false">
                                    <RadzenText TextStyle="TextStyle.Body2">
                                        Completati numele si prenumele pentru a vedea preview-ul.
                                    </RadzenText>
                                </RadzenAlert>
                            }

                            <!-- Informatii business rules -->
                            @if (_showBusinessRulesInfo)
                            {
                                <RadzenAlert AlertStyle="AlertStyle.Warning" ShowIcon="true" AllowClose="false">
                                    <RadzenText TextStyle="TextStyle.Subtitle2" Class="rz-mb-2">Atentie la regulile de afaceri:</RadzenText>
                                    <ul class="rz-m-0" style="padding-left: 20px;">
                                        @if (_showLicentaWarning)
                                        {
                                            <li>Numarul de licenta este obligatoriu pentru pozitiile de doctor/medic</li>
                                        }
                                        @if (_showSpecializareWarning)
                                        {
                                            <li>Specializarea este recomandata pentru aceasta pozitie</li>
                                        }
                                    </ul>
                                </RadzenAlert>
                            }
                        </RadzenStack>
                    </RadzenCard>
                </RadzenColumn>
            </RadzenRow>
        }
        
    </RadzenColumn>
</RadzenRow>

<style>
.business-warning {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.5rem;
    padding: 0.5rem;
    background-color: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 4px;
    color: #856404;
    font-size: 0.875rem;
}

.business-warning .rz-icon {
    color: #856404;
}

.info-message {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.5rem;
    padding: 0.5rem;
    background-color: #d1ecf1;
    border: 1px solid #bee5eb;
    border-radius: 4px;
    color: #0c5460;
    font-size: 0.875rem;
}

.info-message .rz-icon {
    color: #0c5460;
}

/* CSS pentru butoanele imbunatatite */
.rz-button-large {
    font-weight: 600;
    transition: all 0.2s ease;
}

.rz-button-large:hover {
    transform: translateY(-1px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.15) !important;
}
</style>