@page "/administrare/personal"
@using System.ComponentModel.DataAnnotations
@using Client.Models
@using Client.Services
@using Client.Shared.Dialogs
@using MudBlazor
@using Client.Services
@inject IPersoanaService PersoanaService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@using global::Shared.DTOs

<MudText Typo="Typo.h4" Class="mb-4">Administrare Personal</MudText>

<MudPaper Elevation="3" Class="pa-4">
    <MudToolBar Dense="true" DisableGutters="true" Class="mb-2">
        <MudText Typo="Typo.h6">Lista personalului (@personalListFiltrat.Count)</MudText>
        <MudSpacer />
        <MudButton Variant="Variant.Filled" Color="Color.Success" StartIcon="@Icons.Material.Filled.Add" 
                  OnClick="AdaugaAngajat" Disabled="@_loading">Adauga angajat</MudButton>
    </MudToolBar>

    @if (_loadError)
    {
        <MudAlert Severity="Severity.Error" Class="mb-3">
            Nu s-a putut incarca lista de personal. @_errorMessage
            <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="LoadPersonalAsync" Class="ml-auto">
                Incearca din nou
            </MudButton>
        </MudAlert>
    }

    @if (personalListFiltrat.Count == 0 && !_loading && !_loadError)
    {
        <MudAlert Severity="Severity.Info" Dense="true">
            Nu exista personal inregistrat.
        </MudAlert>
    }

    <!-- MudBlazor DataGrid -->
    <MudDataGrid T="PersoanaModel" Items="@personalListFiltrat"
        MultiSelection="true"
        Dense="true"
        Hover="true"
        Bordered="true"
        Striped="true"
        Filterable="true"
        QuickFilter="@_quickFilter"
        SortMode="SortMode.Multiple"
        Hideable="true"
        Loading="@_loading"
        LoadingProgressColor="Color.Primary">

        <ToolBarContent>
            <MudTextField @bind-Value="_searchString" Placeholder="Cauta"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          IconSize="Size.Medium"
                          Class="mt-0"
                          Immediate="true" />
        </ToolBarContent>
        <Columns>
            <HierarchyColumn T="PersoanaModel" />
            <PropertyColumn Property="x => x.Id" Title="ID" Hidden="true" />
            <PropertyColumn Property="x => x.Guid" Title="GUID" Hidden="true" />
            <PropertyColumn Property="x => x.Nume" Title="Nume" Filterable="true" SortBy="x => x.Nume" Groupable="true" />
            <PropertyColumn Property="x => x.Prenume" Title="Prenume" Filterable="true" Groupable="true" />
            <PropertyColumn Property="x => x.CNP" Title="CNP" Filterable="true" Groupable="true" />
            <PropertyColumn Property="x => x.Gen" Title="Gen" Filterable="true" Groupable="true" />
            <PropertyColumn Property="x => x.DataNasterii" Title="Data Nasterii" Format="dd.MM.yyyy" Filterable="true" Groupable="true" />
            <PropertyColumn Property="x => x.StareCivila" Title="Stare Civila" Filterable="true" Groupable="true" />
            <PropertyColumn Property="x => x.DataCreare" Title="Data Creare" Format="dd.MM.yyyy" Filterable="true" Groupable="true" />
            <PropertyColumn Property="x => x.DataModificare" Title="Data Modificare" Format="dd.MM.yyyy HH:mm:ss" Filterable="true" Groupable="true" />

            <!-- Coloane din detaliu, dar Hidden, pentru grupare -->
            <PropertyColumn Property="x => x.TipActIdentitate" Title="Tip Act" Hidden="true" Groupable="true" />
            <PropertyColumn Property="x => x.SerieActIdentitate" Title="Serie Act" Hidden="true" Groupable="true" />
            <PropertyColumn Property="x => x.NumarActIdentitate" Title="Numar Act" Hidden="true" Groupable="true" />
            <PropertyColumn Property="x => x.Judet" Title="Judet" Hidden="true" Groupable="true" />
            <PropertyColumn Property="x => x.Localitate" Title="Localitate" Hidden="true" Groupable="true" />
            <PropertyColumn Property="x => x.Strada" Title="Strada" Hidden="true" Groupable="true" />
            <PropertyColumn Property="x => x.NumarStrada" Title="Numar Strada" Hidden="true" Groupable="true" />
            <PropertyColumn Property="x => x.CodPostal" Title="Cod Postal" Hidden="true" Groupable="true" />
            <PropertyColumn Property="x => x.PozitieOrganizatie" Title="Pozitie" Hidden="true" Groupable="true" />
            <PropertyColumn Property="x => x.Specialitate" Title="Specialitate" Hidden="true" Groupable="true" />
            <PropertyColumn Property="x => x.Departament" Title="Departament" Hidden="true" Groupable="true" />
            <PropertyColumn Property="x => x.DataAngajarii" Title="Data Angajarii" Format="dd.MM.yyyy" Hidden="true" Groupable="true" />
            <PropertyColumn Property="x => x.Status" Title="Status" Hidden="true" Groupable="true" />

            <PropertyColumn T="PersoanaModel" TProperty="string" Title="Actiuni" Sortable="false">
                <CellTemplate>
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Color="Color.Primary"
                                  OnClick="@(() => EditareAngajat(@context.Item))" Disabled="@_loading" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error"
                                  OnClick="@(() => StergereAngajat(@context.Item))" Disabled="@_loading" />
                    <MudIconButton Icon="@Icons.Material.Filled.Visibility" Size="Size.Small" Color="Color.Info"
                                  OnClick="@(() => VizualizareAngajat(@context.Item))" Disabled="@_loading" />
                </CellTemplate>
            </PropertyColumn>
        </Columns>

        <ChildRowContent>
            <MudPaper Class="pa-4" Elevation="0" Style="background: #f9f9f9;">
                <MudText Typo="Typo.subtitle2">Detalii suplimentare</MudText>
                <MudDivider Class="mb-2" />
                <MudGrid>
                    <MudItem xs="12" sm="6">
                        <MudText><b>Tip Act Identitate:</b> @context.Item.TipActIdentitate</MudText>
                        <MudText><b>Serie Act Identitate:</b> @context.Item.SerieActIdentitate</MudText>
                        <MudText><b>Numar Act Identitate:</b> @context.Item.NumarActIdentitate</MudText>
                        <MudText><b>Judet:</b> @context.Item.Judet</MudText>
                        <MudText><b>Localitate:</b> @context.Item.Localitate</MudText>
                        <MudText><b>Strada:</b> @context.Item.Strada</MudText>
                        <MudText><b>Numar Strada:</b> @context.Item.NumarStrada</MudText>
                        <MudText><b>Cod Postal:</b> @context.Item.CodPostal</MudText>
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudText><b>Pozitie Organizatie:</b> @context.Item.PozitieOrganizatie</MudText>
                        <MudText><b>Specialitate:</b> @context.Item.Specialitate</MudText>
                        <MudText><b>Departament:</b> @context.Item.Departament</MudText>
                        <MudText><b>Data Angajarii:</b> @FormatDate(context.Item.DataAngajarii ?? DateTime.MinValue)</MudText>
                        <MudText><b>Status:</b> @context.Item.Status</MudText>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        </ChildRowContent>

        <PagerContent>
            <MudDataGridPager T="PersoanaModel" PageSizeOptions="new int[] { 10, 25, 50, 100 }" />
        </PagerContent>
        <NoRecordsContent>
            <MudText>Nu au fost gasite inregistrari care sa corespunda criteriilor.</MudText>
        </NoRecordsContent>
    </MudDataGrid>
</MudPaper>

@code {
    private string _searchString = "";
    private string _filterNume = "";
    private string _filterSpecialitate = "";
    private string _filterDepartament = "toate";
    private string _filterStatus = "toti";
    private DateTime? _filterDataDeLa;
    private DateTime? _filterDataPanaLa;
    private List<PersoanaModel> personalList = new();
    private List<PersoanaModel> personalListFiltrat = new();
    private bool _loading = false;
    private bool _loadError = false;
    private string _errorMessage = "";
    private string deleteError;

    private PersoanaModel angajat = new PersoanaModel();

    protected override async Task OnInitializedAsync()
    {
        await LoadPersonalAsync();
    }

    private async Task LoadPersonalAsync()
    {
        _loading = true;
        _loadError = false;
        _errorMessage = "";
        deleteError = null;

        try
        {
            personalList = await PersoanaService.GetAllPersonalAsync();
            personalListFiltrat = personalList;
        }
        catch (Exception ex)
        {
            _loadError = true;
            _errorMessage = ex.Message;
            Snackbar.Add($"Eroare la incarcarea datelor: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private string GetStatusBadgeColor(string status)
    {
        return status switch
        {
            "Activ" => "#28a745",
            "Inactiv" => "#dc3545",
            "In concediu" => "#ffc107",
            _ => "#6c757d"
        };
    }

    private void AplicaFiltre()
    {
        _loading = true;
        
        try
        {
            personalListFiltrat = personalList.Where(p => 
                (string.IsNullOrWhiteSpace(_filterNume) || p.Nume?.Contains(_filterNume, StringComparison.OrdinalIgnoreCase) == true) &&
                (string.IsNullOrWhiteSpace(_filterSpecialitate) || p.Specialitate?.Contains(_filterSpecialitate, StringComparison.OrdinalIgnoreCase) == true) &&
                (_filterDepartament == "toate" || p.Departament == _filterDepartament) &&
                (_filterStatus == "toti" || p.Status == _filterStatus) &&
                (!_filterDataDeLa.HasValue || !p.DataAngajarii.HasValue || p.DataAngajarii.Value.Date >= _filterDataDeLa.Value.Date) &&
                (!_filterDataPanaLa.HasValue || !p.DataAngajarii.HasValue || p.DataAngajarii.Value.Date <= _filterDataPanaLa.Value.Date)
            ).ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Eroare la filtrare: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private string FormatDate(DateTime date)
    {
        return date.ToString("dd.MM.yyyy");
    }

    private Color GetStatusColor(string status)
    {
        return status switch
        {
            "Activ" => Color.Success,
            "Inactiv" => Color.Error,
            "In concediu" => Color.Warning,
            _ => Color.Default
        };
    }

    private Func<PersoanaModel, bool> _quickFilter => x =>
    {
        if (string.IsNullOrWhiteSpace(_searchString))
            return true;

        return x.Nume?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true
            || x.Prenume?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true
            || x.Specialitate?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true
            || x.Departament?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true
            || x.Status?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true
            || x.CNP?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true;
    };

    private async Task DeletePersoana(int id)
    {
        var result = await PersoanaService.DeletePersoanaAsync(id);
        if (!result.Success)
        {
            deleteError = result.ErrorMessage;
        }
        else
        {
            deleteError = null;
        }
    }

    private void OnDeleteErrorClose()
    {
        deleteError = null;
    }

    async Task AdaugaAngajat()
    {
        var parameters = new DialogParameters();
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = DialogService.Show<AdaugaEditareAngajatDialog>("Adauga angajat nou", parameters, options);
        var result = await dialog.Result;
        
        if (!result.Canceled)
        {
            var newAngajat = (PersoanaModel)result.Data;
            try
            {
                _loading = true;
                var createPersoanaDTO = newAngajat.ToCreateDto();
                var createdPersoana = await PersoanaService.CreatePersoanaAsync(createPersoanaDTO);
                newAngajat.Id = createdPersoana.Id;
                personalList.Add(newAngajat);
                personalListFiltrat = personalList;
                Snackbar.Add("Angajat adaugat cu succes", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Eroare la adaugarea angajatului: {ex.Message}", Severity.Error);
            }
            finally
            {
                _loading = false;
            }
        }
    }

    async Task EditareAngajat(PersoanaModel angajat)
    {
        var parameters = new DialogParameters();
        parameters.Add("Angajat", angajat);
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = DialogService.Show<AdaugaEditareAngajatDialog>("Editeaza angajat", parameters, options);
        var result = await dialog.Result;
        
        if (!result.Canceled)
        {
            var updatedAngajat = (PersoanaModel)result.Data;
            try
            {
                _loading = true;
                var updateDto = updatedAngajat.ToUpdateDto();
                var success = await PersoanaService.UpdatePersoanaAsync(updateDto);
                if (success)
                {
                    var index = personalList.FindIndex(p => p.Id == updatedAngajat.Id);
                    if (index >= 0)
                    {
                        personalList[index] = updatedAngajat;
                        personalListFiltrat = personalList;
                    }
                    Snackbar.Add("Angajat actualizat cu succes", Severity.Success);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Eroare la actualizarea angajatului: {ex.Message}", Severity.Error);
            }
            finally
            {
                _loading = false;
            }
        }
    }

    async Task StergereAngajat(PersoanaModel angajat)
    {
        var parameters = new DialogParameters
        {
            { "ContentText", $"Sigur doriti sa stergeti angajatul {angajat.Nume} {angajat.Prenume}?" },
            { "ButtonText", "Sterge" },
            { "Color", Color.Error }
        };
        
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.ExtraSmall };
        var dialogResult = await DialogService.Show<ConfirmDialog>("Confirmare stergere", parameters, options).Result;
        
        if (!dialogResult.Canceled)
        {
            try
            {
                _loading = true;
                var result = await PersoanaService.DeletePersoanaAsync(angajat.Id);
                if (result.Success)
                {
                    personalList.Remove(angajat);
                    personalListFiltrat = personalList.ToList();
                    Snackbar.Add("Angajat sters cu succes", Severity.Success);
                }
                else
                {
                    deleteError = result.ErrorMessage;
                    Snackbar.Add(deleteError, Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Eroare la stergerea angajatului: {ex.Message}", Severity.Error);
            }
            finally
            {
                _loading = false;
            }
        }
    }

    void VizualizareAngajat(PersoanaModel angajat)
    {
        var parameters = new DialogParameters();
        parameters.Add("Angajat", angajat);
        parameters.Add("ReadOnly", true);
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        DialogService.Show<AdaugaEditareAngajatDialog>($"Detalii angajat: {angajat.Nume} {angajat.Prenume}", parameters, options);
    }
}