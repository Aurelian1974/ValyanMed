@page "/autentificare"
@using System.ComponentModel.DataAnnotations
@using Client.Services
@using Client.Validators
@using FluentValidation
@using Client.Models
@inject NavigationManager Navigation
@inject IAuthService AuthService
@inject ISnackbar Snackbar

<MudPaper Class="signin-container" Elevation="3" Square="false">
    <MudStack Direction="Row" AlignItems="AlignItems.Center" Spacing="0" Class="title-row">
        <img src="images/valyanmed-logo.png" alt="ValyanMed Logo" class="logo-img-inline" />
        <MudText Typo="Typo.h4" Class="signin-title" GutterBottom="false" Bold="true">
            Autentificare
        </MudText>
    </MudStack>

    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <MudAlert Severity="MudBlazor.Severity.Error" Class="mb-4">
            @_errorMessage
        </MudAlert>
    }

    <MudForm Model="@_loginModel" @ref="_form" Validation="@(_loginValidator.ValidateValue)" ValidationDelay="0">
        <MudValidationSummary />

        <MudTextField @bind-Value="_loginModel.NumeUtilizatorSauEmail"
                      For="@(() => _loginModel.NumeUtilizatorSauEmail)"
                      Immediate="true"
                      Label="Utilizator sau Email"
                      Variant="Variant.Outlined"
                      Class="mb-4" />

        <MudTextField @bind-Value="_loginModel.Parola"
                      For="@(() => _loginModel.Parola)"
                      Immediate="true"
                      Label="Parola"
                      Variant="Variant.Outlined"
                      InputType="@(_showPassword ? InputType.Text : InputType.Password)"
                      Class="mb-4"
                      Adornment="Adornment.End"
                      AdornmentIcon="@(_showPassword ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)"
                      OnAdornmentClick="TogglePasswordVisibility" />

        <MudStack Direction="Row" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <MudButton Variant="Variant.Filled"
                      Color="Color.Primary"
                      Class="signin-btn"
                      ButtonType="ButtonType.Submit"
                      FullWidth="true"
                      Disabled="@_isLoading"
                      OnClick="@(async () => await Login())">
                @if (_isLoading)
                {
                    <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                    <MudText Class="ms-2">Se proceseaza...</MudText>
                }
                else
                {
                    <MudText>Autentificare</MudText>
                }
            </MudButton>
            <MudLink Href="#" Class="forgot-link">Ai uitat parola?</MudLink>
        </MudStack>
        <MudDivider Class="mb-4" />
        <MudText>
            Nu ai inca cont de utilizator?
            <MudLink Href="/inregistrare">Creeaza cont</MudLink>
        </MudText>
    </MudForm>
</MudPaper>

@code {
    private MudForm _form;
    private string _errorMessage;
    private bool _showPassword;
    private bool _isLoading;
    private LoginDto _loginModel = new();
    private LoginValidator _loginValidator = new();

    public class LoginValidator : AbstractValidator<LoginDto>
    {
        public LoginValidator()
        {
            RuleFor(x => x.NumeUtilizatorSauEmail)
                .NotEmpty().WithMessage("Utilizatorul sau email-ul este obligatoriu");

            RuleFor(x => x.Parola)
                .NotEmpty().WithMessage("Parola este obligatorie");
        }

        public Func<object, string, Task<IEnumerable<string>>> ValidateValue => async (model, propertyName) =>
        {
            var result = await ValidateAsync(ValidationContext<LoginDto>.CreateWithOptions((LoginDto)model, x => x.IncludeProperties(propertyName)));
            if (result.IsValid)
                return Array.Empty<string>();
            return result.Errors.Select(e => e.ErrorMessage);
        };
    }

    private async Task Login()
    {
        _isLoading = true;
        _errorMessage = string.Empty;
        await _form.Validate();

        if (_form.IsValid)
        {
            try
            {
                var (success, message, token) = await AuthService.Login(_loginModel.NumeUtilizatorSauEmail, _loginModel.Parola);

                if (success)
                {
                    Snackbar.Add("Autentificare reusita!", MudBlazor.Severity.Success);
                    Navigation.NavigateTo("/dashboard", forceLoad: true);
                }
                else
                {
                    _errorMessage = message;
                    Snackbar.Add($"Eroare la autentificare: {_errorMessage}", MudBlazor.Severity.Error);
                }
            }
            catch (Exception ex)
            {
                _errorMessage = $"A aparut o eroare: {ex.Message}";
                Snackbar.Add(_errorMessage, MudBlazor.Severity.Error);
            }
        }

        _isLoading = false;
        StateHasChanged();
    }

    void TogglePasswordVisibility() => _showPassword = !_showPassword;
}
