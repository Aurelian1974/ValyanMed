@inherits LayoutComponentBase
@using Microsoft.AspNetCore.Components.Authorization
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

<MudThemeProvider />
<MudDialogProvider />
<MudSnackbarProvider />
<MudPopoverProvider />

<MudLayout>
    <!-- Header Bar -->
    <MudAppBar Elevation="1" Color="Color.Primary" Dense="true">
        <div class="app-logo">
            <MudIcon Icon="@Icons.Material.Filled.LocalHospital" Size="Size.Medium" />
            <MudText Typo="Typo.h6">ValyanMed</MudText>
        </div>
        <MudSpacer />
        
        <!-- User menu and logout -->
        <MudMenu Color="Color.Inherit" Icon="@Icons.Material.Filled.AccountCircle" Dense="true" AnchorOrigin="Origin.TopRight" TransformOrigin="Origin.TopRight">
            <MudMenuItem Href="/profil" Icon="@Icons.Material.Filled.ManageAccounts">Profil</MudMenuItem>
            <MudMenuItem OnClick="Logout" Icon="@Icons.Material.Filled.Logout">Delogare</MudMenuItem>
        </MudMenu>

        <MudButton 
            OnClick="Logout" 
            StartIcon="@Icons.Material.Filled.Logout" 
            Color="Color.Inherit" 
            Class="ml-2" 
            Variant="Variant.Text">
            Delogare
        </MudButton>
    </MudAppBar>

    <!-- Left Sidebar -->
    <MudDrawer Open="true" ClipMode="DrawerClipMode.Always" Elevation="2" Variant="DrawerVariant.Persistent">
        <MudDrawerHeader>
            <MudText Typo="Typo.h6">ValyanMed</MudText>
        </MudDrawerHeader>
        <MudNavMenu>
            <MudNavLink Href="/dashboard" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Dashboard">Dashboard</MudNavLink>
            <MudNavLink Href="/pacienti" Icon="@Icons.Material.Filled.People">Pacienti</MudNavLink>
            <MudNavLink Href="/rapoarte" Icon="@Icons.Material.Filled.Assessment">Rapoarte</MudNavLink>
            <MudNavLink Href="/facturare" Icon="@Icons.Material.Filled.Receipt">Facturare</MudNavLink>

            <!-- Farmacie submenu -->
            <MudNavLink Icon="@Icons.Material.Filled.LocalPharmacy" @onclick="@ToggleFarmacieMenu" Class="admin-nav-link">
                Farmacie
            </MudNavLink>
            @if (_farmacieExpanded)
            {
                <div style="margin-left:32px;">
                    <MudNavLink Href="/farmacie/medicamente" Icon="@Icons.Material.Filled.Medication">Medicamente</MudNavLink>
                    <MudNavLink Href="/farmacie/materiale-sanitare" Icon="@Icons.Material.Filled.MedicalServices">Materiale sanitare</MudNavLink>
                    <MudNavLink Href="/farmacie/dispozitive-medicale" Icon="@Icons.Material.Filled.MedicalInformation">Dispozitive medicale</MudNavLink>
                    <MudNavLink Href="/farmacie/documente-intrare" Icon="@Icons.Material.Filled.Input">Documente intrare</MudNavLink>
                    <MudNavLink Href="/farmacie/documente-iesire" Icon="@Icons.Material.Filled.Output">Documente iesire</MudNavLink>
                </div>
            }

            <MudNavLink Href="/setari" Icon="@Icons.Material.Filled.Settings">Setari</MudNavLink>

            <!-- Admin menu -->
            <MudNavLink Icon="@Icons.Material.Filled.AdminPanelSettings"
                        @onclick="@ToggleAdminMenu"
                        Class="admin-nav-link">
                Administrare
            </MudNavLink>
            @if (_adminExpanded)
            {
                <div style="margin-left:32px;">
                    <MudNavLink Href="/persoane" Icon="@Icons.Material.Filled.People">Persoane</MudNavLink>
                    <MudNavLink Href="/utilizatori" Icon="@Icons.Material.Filled.ManageAccounts">Utilizatori</MudNavLink>
                    <MudNavLink Href="/administrare/parteneri" Icon="@Icons.Material.Filled.Business">Parteneri</MudNavLink>
                    <MudNavLink Href="/administrare/roluri" Icon="@Icons.Material.Filled.GroupWork">Roluri</MudNavLink>
                </div>
            }
        </MudNavMenu>
    </MudDrawer>

    <!-- Main Content -->
    <MudMainContent Class="main-content">
        <MudContainer MaxWidth="MaxWidth.ExtraLarge">
            @Body
        </MudContainer>
    </MudMainContent>
</MudLayout>

@code {
    private bool _adminExpanded = false;
    private bool _farmacieExpanded = false;

    private async Task Logout()
    {
        try
        {
            // Call API logout + clear storage via JS helper (uses sendBeacon on unload)
            await JSRuntime.InvokeVoidAsync("appLifecycle.logoutNow", "https://localhost:7294/api/auth/logout", 
                new[] { "valyanmed_auth_token", "valyanmed_user_info", "currentUser" });
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Logout error: {ex.Message}");
        }
        finally
        {
            NavigationManager.NavigateTo("/login", forceLoad: true);
        }
    }

    void ToggleAdminMenu() => _adminExpanded = !_adminExpanded;
    void ToggleFarmacieMenu() => _farmacieExpanded = !_farmacieExpanded;
}
