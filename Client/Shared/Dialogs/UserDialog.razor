@inherits UserDialogBase

<MudDialog>
    <DialogContent>
        <FluentValidationValidator />
        <MudForm @ref="form" Model="@Model" Validation="@Validator.ValidateValue">
            <MudContainer Style="max-height: 70vh; overflow-y: auto;">
                <MudStack Spacing="3">
                    <!-- User Credentials Section -->
                    <MudStack Spacing="2">
                        <MudText Typo="Typo.h6" Color="Color.Primary">Credentiale Utilizator</MudText>
                        
                        <MudGrid>
                            <MudItem xs="12" md="6">
                                <MudTextField @bind-Value="Model.NumeUtilizator"
                                            For="@(() => Model.NumeUtilizator)"
                                            Label="Nume Utilizator *"
                                            Variant="Variant.Outlined"
                                            Required="true"
                                            Immediate="true" />
                            </MudItem>
                            <MudItem xs="12" md="6">
                                <MudTextField @bind-Value="Model.Email"
                                            For="@(() => Model.Email)"
                                            Label="Email *"
                                            Variant="Variant.Outlined"
                                            InputType="InputType.Email"
                                            Required="true"
                                            Immediate="true" />
                            </MudItem>
                        </MudGrid>

                        <MudTextField @bind-Value="Model.Telefon"
                                    For="@(() => Model.Telefon)"
                                    Label="Telefon"
                                    Variant="Variant.Outlined"
                                    Immediate="true" />
                    </MudStack>

                    <!-- Password Section -->
                    <MudDivider />
                    <MudStack Spacing="2">
                        <MudText Typo="Typo.h6" Color="Color.Primary">
                            @if (IsEditMode)
                            {
                                @:Schimbare Parola
                            }
                            else
                            {
                                @:Parola
                            }
                        </MudText>
                        
                        @if (!IsEditMode)
                        {
                            <MudTextField @bind-Value="Model.Parola"
                                        For="@(() => Model.Parola)"
                                        Label="Parola *"
                                        Variant="Variant.Outlined"
                                        InputType="@(ShowPassword ? InputType.Text : InputType.Password)"
                                        Adornment="Adornment.End"
                                        AdornmentIcon="@(ShowPassword ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)"
                                        OnAdornmentClick="@(() => ShowPassword = !ShowPassword)"
                                        Required="true"
                                        Immediate="true" />
                        }
                        else
                        {
                            <MudTextField @bind-Value="Model.NovaParola"
                                        For="@(() => Model.NovaParola)"
                                        Label="Parola Noua (optional)"
                                        Variant="Variant.Outlined"
                                        InputType="@(ShowPassword ? InputType.Text : InputType.Password)"
                                        Adornment="Adornment.End"
                                        AdornmentIcon="@(ShowPassword ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)"
                                        OnAdornmentClick="@(() => ShowPassword = !ShowPassword)"
                                        HelperText="Lasati gol pentru a pastra parola actuala"
                                        Immediate="true" />
                        }
                    </MudStack>

                    <!-- Person Association Section -->
                    <MudDivider />
                    <MudStack Spacing="2">
                        <MudText Typo="Typo.h6" Color="Color.Primary">Asociere Persoana</MudText>
                        
                        <MudSelect T="int?" @bind-Value="Model.SelectedPersoanaId"
                                 For="@(() => Model.SelectedPersoanaId)"
                                 Label="Persoana Asociata *"
                                 Variant="Variant.Outlined"
                                 Required="true"
                                 AnchorOrigin="Origin.BottomCenter"
                                 ToStringFunc="@(id => GetPersonDisplayName(id))">
                            <MudSelectItem T="int?" Value="@((int?)null)">Selectati o persoana</MudSelectItem>
                            @foreach (var persoana in AvailablePersons)
                            {
                                <MudSelectItem T="int?" Value="@((int?)persoana.Id)">
                                    @persoana.NumeComplet
                                </MudSelectItem>
                            }
                        </MudSelect>

                        @if (Model.SelectedPersoanaId.HasValue)
                        {
                            var selectedPerson = AvailablePersons.FirstOrDefault(p => p.Id == Model.SelectedPersoanaId.Value);
                            if (selectedPerson != null)
                            {
                                <MudAlert Severity="MudSeverity.Info" Dense="true">
                                    <MudStack Row Spacing="2" AlignItems="AlignItems.Center">
                                        <MudIcon Icon="@Icons.Material.Filled.Person" />
                                        <MudStack Spacing="0">
                                            <MudText Typo="Typo.body2"><strong>@selectedPerson.NumeComplet</strong></MudText>
                                            @if (!string.IsNullOrEmpty(selectedPerson.CNP))
                                            {
                                                <MudText Typo="Typo.caption">CNP: @selectedPerson.CNP</MudText>
                                            }
                                            @if (!string.IsNullOrEmpty(selectedPerson.PozitieOrganizatie))
                                            {
                                                <MudText Typo="Typo.caption">Pozitie: @selectedPerson.PozitieOrganizatie</MudText>
                                            }
                                        </MudStack>
                                    </MudStack>
                                </MudAlert>
                            }
                        }
                    </MudStack>
                </MudStack>
            </MudContainer>
        </MudForm>
    </DialogContent>
    
    <DialogActions>
        <MudButton OnClick="Cancel" Color="Color.Secondary">Anuleaza</MudButton>
        <MudButton OnClick="Submit" 
                  Color="Color.Primary" 
                  Variant="Variant.Filled"
                  Disabled="@IsSubmitting"
                  StartIcon="@(IsSubmitting ? Icons.Material.Filled.HourglassEmpty : (IsEditMode ? Icons.Material.Filled.Save : Icons.Material.Filled.Add))">
            @if (IsSubmitting)
            {
                @:Se proceseaza...
            }
            else if (IsEditMode)
            {
                @:Actualizeaza
            }
            else
            {
                @:Adauga
            }
        </MudButton>
    </DialogActions>
</MudDialog>