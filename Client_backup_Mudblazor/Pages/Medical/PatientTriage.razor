@page "/medical/triaj"
@using global::Shared.DTOs.Medical
@using global::Shared.Models.Medical
@using global::Shared.Enums.Medical
@using MudBlazor
@inject HttpClient Http
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<PageTitle>Triaj Pacien?i - ValyanMed</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="pa-4">
    <!-- Header -->
    <MudPaper Class="pa-4 mb-4" Elevation="2">
        <MudGrid AlignItems="Center">
            <MudItem xs="12" md="8">
                <MudText Typo="Typo.h4" Color="Color.Primary">
                    <MudIcon Icon="Icons.Material.Filled.PriorityHigh" Class="mr-3" />
                    Triaj Pacien?i
                </MudText>
                <MudText Typo="Typo.body1" Color="Color.Secondary">
                    Evaluarea ini?ial? ?i clasificarea priorit??ii pacien?ilor
                </MudText>
            </MudItem>
            <MudItem xs="12" md="4" Class="d-flex justify-end">
                <MudButton Variant="Variant.Outlined" 
                          Color="Color.Secondary" 
                          StartIcon="Icons.Material.Filled.ArrowBack"
                          OnClick="@(() => Navigation.NavigateTo("/medical/dashboard"))">
                    Înapoi la Dashboard
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <!-- Triaj Levels Guide -->
    <MudPaper Class="pa-4 mb-4" Elevation="1">
        <MudText Typo="Typo.h6" Class="mb-3">
            <MudIcon Icon="Icons.Material.Filled.Info" Class="mr-2" />
            Ghid niveluri de triaj
        </MudText>
        <MudGrid>
            <MudItem xs="12" sm="6" md="2">
                <MudCard Style="border-left: 4px solid var(--mud-palette-error);">
                    <MudCardContent Class="pa-3">
                        <MudText Typo="Typo.h6" Color="Color.Error">Nivel 1</MudText>
                        <MudText Typo="Typo.body2">CRITIC</MudText>
                        <MudText Typo="Typo.caption">Risc vital imediat</MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>
            <MudItem xs="12" sm="6" md="2">
                <MudCard Style="border-left: 4px solid var(--mud-palette-warning);">
                    <MudCardContent Class="pa-3">
                        <MudText Typo="Typo.h6" Color="Color.Warning">Nivel 2</MudText>
                        <MudText Typo="Typo.body2">URGENT</MudText>
                        <MudText Typo="Typo.caption">Risc poten?ial vital</MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>
            <MudItem xs="12" sm="6" md="2">
                <MudCard Style="border-left: 4px solid var(--mud-palette-info);">
                    <MudCardContent Class="pa-3">
                        <MudText Typo="Typo.h6" Color="Color.Info">Nivel 3</MudText>
                        <MudText Typo="Typo.body2">MODERAT</MudText>
                        <MudText Typo="Typo.caption">Evaluare rapid?</MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>
            <MudItem xs="12" sm="6" md="2">
                <MudCard Style="border-left: 4px solid var(--mud-palette-primary);">
                    <MudCardContent Class="pa-3">
                        <MudText Typo="Typo.h6" Color="Color.Primary">Nivel 4</MudText>
                        <MudText Typo="Typo.body2">SC?ZUT</MudText>
                        <MudText Typo="Typo.caption">Poate a?tepta</MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>
            <MudItem xs="12" sm="6" md="2">
                <MudCard Style="border-left: 4px solid var(--mud-palette-success);">
                    <MudCardContent Class="pa-3">
                        <MudText Typo="Typo.h6" Color="Color.Success">Nivel 5</MudText>
                        <MudText Typo="Typo.body2">NEURGENT</MudText>
                        <MudText Typo="Typo.caption">F?r? risc</MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <!-- Quick Actions -->
    <MudGrid Class="mb-4">
        <MudItem xs="12" sm="6" md="3">
            <MudButton Variant="Variant.Filled"
                      Color="Color.Error"
                      StartIcon="Icons.Material.Filled.LocalHospital"
                      FullWidth="true"
                      Class="pa-4"
                      OnClick="() => QuickTriaj(1)">
                <div>
                    <MudText Typo="Typo.h6">URGENT NIVEL 1</MudText>
                    <MudText Typo="Typo.caption">Risc vital imediat</MudText>
                </div>
            </MudButton>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudButton Variant="Variant.Filled"
                      Color="Color.Warning"
                      StartIcon="Icons.Material.Filled.Warning"
                      FullWidth="true"
                      Class="pa-4"
                      OnClick="() => QuickTriaj(2)">
                <div>
                    <MudText Typo="Typo.h6">URGENT NIVEL 2</MudText>
                    <MudText Typo="Typo.caption">Risc poten?ial vital</MudText>
                </div>
            </MudButton>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudButton Variant="Variant.Outlined"
                      Color="Color.Primary"
                      StartIcon="Icons.Material.Filled.Assignment"
                      FullWidth="true"
                      Class="pa-4"
                      OnClick="StartDetailedTriaj">
                <div>
                    <MudText Typo="Typo.h6">TRIAJ DETALIAT</MudText>
                    <MudText Typo="Typo.caption">Evaluare complet?</MudText>
                </div>
            </MudButton>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudButton Variant="Variant.Outlined"
                      Color="Color.Success"
                      StartIcon="Icons.Material.Filled.Search"
                      FullWidth="true"
                      Class="pa-4"
                      OnClick="SearchPatient">
                <div>
                    <MudText Typo="Typo.h6">C?UTARE PACIENT</MudText>
                    <MudText Typo="Typo.caption">Istoric triaj</MudText>
                </div>
            </MudButton>
        </MudItem>
    </MudGrid>

    <!-- Triaj în a?teptare ast?zi -->
    <MudPaper Class="pa-4 mb-4" Elevation="2">
        <MudText Typo="Typo.h6" Class="mb-3">
            <MudIcon Icon="Icons.Material.Filled.Today" Class="mr-2" />
            Triaj în a?teptare ast?zi
        </MudText>

        @if (_triajAstazi?.Any() == true)
        {
            <MudTable Items="_triajAstazi" Hover="true" Dense="true">
                <HeaderContent>
                    <MudTh>Ora</MudTh>
                    <MudTh>Pacient</MudTh>
                    <MudTh>Nivel triaj</MudTh>
                    <MudTh>Plângerea principal?</MudTh>
                    <MudTh>Status</MudTh>
                    <MudTh>Ac?iuni</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>
                        <MudText Typo="Typo.body2">
                            @context.DataTriaj.ToString("HH:mm")
                        </MudText>
                    </MudTd>
                    <MudTd>
                        <MudText Typo="Typo.body2">Pacient @context.TriajID.ToString().Substring(0, 8)</MudText>
                    </MudTd>
                    <MudTd>
                        <MudChip T="string" Size="Size.Small" Color="@GetTriajColor(context.NivelTriaj)">
                            @context.NivelTriajText
                        </MudChip>
                    </MudTd>
                    <MudTd>
                        <MudText Typo="Typo.body2">
                            @(context.PlangereaPrincipala.Length > 50 ? context.PlangereaPrincipala.Substring(0, 50) + "..." : context.PlangereaPrincipala)
                        </MudText>
                    </MudTd>
                    <MudTd>
                        <MudChip T="string" Size="Size.Small" Color="Color.Warning">În a?teptare</MudChip>
                    </MudTd>
                    <MudTd>
                        <MudButtonGroup Size="Size.Small" Variant="Variant.Text">
                            <MudButton StartIcon="Icons.Material.Filled.Edit"
                                      Color="Color.Primary"
                                      OnClick="() => EditTriaj(context.TriajID)">
                                Editeaz?
                            </MudButton>
                            <MudButton StartIcon="Icons.Material.Filled.MedicalServices"
                                      Color="Color.Success"
                                      OnClick="() => StartConsultation(context.ProgramareID)">
                                Consulta?ie
                            </MudButton>
                        </MudButtonGroup>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        }
        else
        {
            <MudAlert Severity="MudBlazor.Severity.Info">
                Nu exist? triaj în a?teptare pentru ast?zi.
            </MudAlert>
        }
    </MudPaper>

    <!-- Statistici triaj -->
    <MudGrid>
        <MudItem xs="12" sm="6" md="3">
            <MudCard Class="pa-3">
                <MudCardContent Class="pa-0">
                    <MudGrid AlignItems="Center" Spacing="0">
                        <MudItem xs="8">
                            <MudText Typo="Typo.h6" Color="Color.Error">@_statisticiTriaj.Nivel1</MudText>
                            <MudText Typo="Typo.caption">Nivel 1 - Critic</MudText>
                        </MudItem>
                        <MudItem xs="4" Class="text-right">
                            <MudIcon Icon="Icons.Material.Filled.LocalHospital" Color="Color.Error" />
                        </MudItem>
                    </MudGrid>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudCard Class="pa-3">
                <MudCardContent Class="pa-0">
                    <MudGrid AlignItems="Center" Spacing="0">
                        <MudItem xs="8">
                            <MudText Typo="Typo.h6" Color="Color.Warning">@_statisticiTriaj.Nivel2</MudText>
                            <MudText Typo="Typo.caption">Nivel 2 - Urgent</MudText>
                        </MudItem>
                        <MudItem xs="4" Class="text-right">
                            <MudIcon Icon="Icons.Material.Filled.Warning" Color="Color.Warning" />
                        </MudItem>
                    </MudGrid>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudCard Class="pa-3">
                <MudCardContent Class="pa-0">
                    <MudGrid AlignItems="Center" Spacing="0">
                        <MudItem xs="8">
                            <MudText Typo="Typo.h6" Color="Color.Info">@_statisticiTriaj.Nivel3</MudText>
                            <MudText Typo="Typo.caption">Nivel 3 - Moderat</MudText>
                        </MudItem>
                        <MudItem xs="4" Class="text-right">
                            <MudIcon Icon="Icons.Material.Filled.Schedule" Color="Color.Info" />
                        </MudItem>
                    </MudGrid>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudCard Class="pa-3">
                <MudCardContent Class="pa-0">
                    <MudGrid AlignItems="Center" Spacing="0">
                        <MudItem xs="8">
                            <MudText Typo="Typo.h6" Color="Color.Success">@(_statisticiTriaj.Nivel4 + _statisticiTriaj.Nivel5)</MudText>
                            <MudText Typo="Typo.caption">Nivel 4-5 - Stabil</MudText>
                        </MudItem>
                        <MudItem xs="4" Class="text-right">
                            <MudIcon Icon="Icons.Material.Filled.CheckCircle" Color="Color.Success" />
                        </MudItem>
                    </MudGrid>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>
</MudContainer>

<!-- Quick Triaj Dialog -->
<MudDialog @bind-IsVisible="_showQuickTriajDialog" Options="_dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@GetTriajIcon(_selectedNivelTriaj)" Class="mr-3" Color="@GetTriajColor(_selectedNivelTriaj)" />
            Triaj rapid - Nivel @_selectedNivelTriaj
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudTextField @bind-Value="_quickTriajComplaint"
                     Label="Plângerea principal? *"
                     Placeholder="Descrie?i motivul pentru care pacientul solicit? asisten?? medical?"
                     Lines="3"
                     Variant="Variant.Outlined"
                     Required="true" />
                     
        <MudTextField @bind-Value="_quickTriajNotes"
                     Label="Observa?ii suplimentare"
                     Placeholder="Observa?ii despre starea pacientului"
                     Lines="2"
                     Variant="Variant.Outlined"
                     Class="mt-4" />
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseQuickTriaj">Anuleaz?</MudButton>
        <MudButton Color="@GetTriajColor(_selectedNivelTriaj)" 
                  Variant="Variant.Filled"
                  OnClick="SaveQuickTriaj"
                  Disabled="_isSavingTriaj"
                  StartIcon="@(_isSavingTriaj ? null : Icons.Material.Filled.Save)">
            @if (_isSavingTriaj)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                <span class="ml-2">Se salveaz?...</span>
            }
            else
            {
                <span>Salveaz? triajul</span>
            }
        </MudButton>
    </DialogActions>
</MudDialog>